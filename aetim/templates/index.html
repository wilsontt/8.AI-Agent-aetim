<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AETIM - 自動化威脅情資管理系統</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;700&display=swap" rel="stylesheet">

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: ''Noto Sans TC', Microsoft JhengHei', 'Segoe UI', Arial, sans-serif;
            /* font-family: 'Noto Sans TC', 'Microsoft JhengHei', sans-serif; */
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            overflow: hidden;
        }

        /* 上半部：標題與時間 */
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 15px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .header .datetime {
            font-size: 1.3em;
            font-weight: 300;
            opacity: 0.95;
        }

        /* 中間部分：設定區 */
        .middle-section {
            padding: 30px;
            background: #f8f9fa;
            border-bottom: 2px solid #e0e0e0;
        }

        .section-title {
            font-size: 1.5em;
            color: #333;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #667eea;
        }

        .config-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .config-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .config-card h3 {
            color: #667eea;
            margin-bottom: 15px;
            font-size: 1.2em;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            color: #555;
            font-weight: 500;
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 1em;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 5px rgba(102, 126, 234, 0.3);
        }

        .btn {
            padding: 12px 30px;
            border: none;
            border-radius: 5px;
            font-size: 1em;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 500;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-success:hover {
            background: #218838;
            transform: translateY(-2px);
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        .btn-danger:hover {
            background: #c82333;
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .btn-group {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        /* 下半部：處理狀態區 */
        .bottom-section {
            padding: 30px;
        }

        .status-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 20px;
        }

        .status-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .status-card h3 {
            color: #667eea;
            margin-bottom: 15px;
            font-size: 1.2em;
        }

        .status-indicator {
            display: inline-block;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.9em;
            font-weight: 500;
            margin-bottom: 15px;
        }

        .status-idle {
            background: #e0e0e0;
            color: #666;
        }

        .status-running {
            background: #ffc107;
            color: #856404;
            animation: pulse 1.5s infinite;
        }

        .status-completed {
            background: #28a745;
            color: white;
        }

        .status-error {
            background: #dc3545;
            color: white;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        .log-container {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            max-height: 300px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
            margin-top: 10px;
        }

        .log-entry {
            padding: 5px 0;
            border-bottom: 1px solid #e0e0e0;
        }

        .log-entry:last-child {
            border-bottom: none;
        }

        .timestamp {
            color: #999;
            font-size: 0.85em;
            margin-top: 10px;
        }

        .report-options {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 15px;
        }

        .notification-options {
            display: grid;
            grid-template-columns: 1fr;
            gap: 10px;
            margin-bottom: 15px;
        }

        .checkbox-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .checkbox-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .checkbox-item input[type="checkbox"] {
            width: auto;
        }

        .alert {
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 15px;
        }

        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .alert-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .alert-info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        /* 頁籤樣式 */
        .tabs {
            display: flex;
            background: #f8f9fa;
            border-bottom: 2px solid #e0e0e0;
            padding: 0 30px;
        }

        .tab-button {
            padding: 15px 30px;
            background: transparent;
            border: none;
            border-bottom: 3px solid transparent;
            cursor: pointer;
            font-size: 1.1em;
            font-weight: 500;
            color: #666;
            transition: all 0.3s;
            font-family: inherit;
        }

        .tab-button:hover {
            color: #667eea;
            background: rgba(102, 126, 234, 0.1);
        }

        .tab-button.active {
            color: #667eea;
            border-bottom-color: #667eea;
            background: white;
        }

        .tab-content {
            display: none;
            padding: 30px;
        }

        .tab-content.active {
            display: block;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- 上半部：標題與時間 -->
        <div class="header">
            <h1>AETIM - 自動化威脅情資管理系統</h1>
            <div class="datetime" id="datetime"></div>
        </div>
        
        <!-- 頁籤導航 -->
        <div class="tabs">
            <button class="tab-button" onclick="switchTab('status')">處理狀態與報告</button>
            <button class="tab-button active" onclick="switchTab('settings')">設定與控制</button>
        </div>
        
        <!-- 下半部：頁籤內容顯示 -->
        <!-- 頁籤 1：設定與控制 -->
        <div id="settings-tab" class="tab-content active">
            <div class="middle-section" style="padding: 0; background: transparent; border: none;">
            
            <div class="config-grid">
                <!-- 排程設定（整合基本排程與動態排程） -->
                <div class="config-card">
                    <h3>排程設定</h3>
                    <div class="form-group">
                        <label>排程狀態</label>
                        <select id="schedulerStatus">
                            <option value="enabled">啟用</option>
                            <option value="disabled">停用</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>下次執行時間</label>
                        <input type="text" id="nextRunTime" readonly value="計算中...">
                    </div>
                    <div class="form-group">
                        <label>執行間隔（小時）</label>
                        <select id="intervalHours">
                            <option value="">不使用</option>
                            <option value="1">1 小時</option>
                            <option value="2">2 小時</option>
                            <option value="4" selected>4 小時</option>
                            <option value="6">6 小時</option>
                            <option value="12">12 小時</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>執行間隔（分鐘）</label>
                        <select id="intervalMinutes">
                            <option value="">不使用</option>
                            <option value="5">5 分鐘</option>
                            <option value="10">10 分鐘</option>
                            <option value="15">15 分鐘</option>
                            <option value="30">30 分鐘</option>
                        </select>
                    </div>
                    <div style="margin-top: 15px;">
                        <button class="btn btn-primary" onclick="updateScheduler()">更新排程設定</button>
                    </div>
                </div>

                <!-- SMTP 設定 -->
                <div class="config-card">
                    <h3>SMTP 設定</h3>
                    <div class="form-group">
                        <label>SMTP 伺服器</label>
                        <input type="text" id="smtpServer" placeholder="smtp.gmail.com">
                    </div>
                    <div class="form-group">
                        <label>SMTP 埠口</label>
                        <input type="number" id="smtpPort" placeholder="587" min="1" max="65535">
                    </div>
                    <div class="form-group">
                        <label>SMTP 使用者名稱</label>
                        <input type="text" id="smtpUsername" placeholder="your-email@gmail.com">
                    </div>
                    <div class="form-group">
                        <label>SMTP 密碼</label>
                        <input type="password" id="smtpPassword" placeholder="your-password">
                    </div>
                    <div class="form-group">
                        <label>發送者 Email</label>
                        <input type="email" id="emailFrom" placeholder="sender@company.com">
                    </div>
                    <div class="form-group">
                        <label>使用 TLS</label>
                        <select id="smtpUseTLS">
                            <option value="true">是</option>
                            <option value="false">否</option>
                        </select>
                    </div>
                    <div style="display: flex; gap: 10px; margin-top: 15px;">
                        <button class="btn btn-success" onclick="testSMTP()">測試 SMTP</button>
                        <button class="btn btn-primary" onclick="updateSMTP()">儲存 SMTP 設定</button>
                    </div>
                </div>
                
                <!-- 週報排程設定 -->
                <div class="config-card">
                    <h3>週報排程設定（CISO 週報）</h3>
                    <div class="form-group">
                        <label>星期</label>
                        <select id="weeklyDay">
                            <option value="mon">週一 (mon)</option>
                            <option value="tue">週二 (tue)</option>
                            <option value="wed">週三 (wed)</option>
                            <option value="thu">週四 (thu)</option>
                            <option value="fri">週五 (fri)</option>
                            <option value="sat">週六 (sat)</option>
                            <option value="sun">週日 (sun)</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>小時（0-23）</label>
                        <input type="number" id="weeklyHour" min="0" max="23" value="8">
                    </div>
                    <div class="form-group">
                        <label>分鐘（0-59）</label>
                        <input type="number" id="weeklyMinute" min="0" max="59" value="0">
                    </div>
                    <div style="margin-top: 15px;">
                        <button class="btn btn-primary" onclick="updateWeeklySchedule()">更新週報排程</button>
                    </div>
                </div>

                <!-- 週報排程通知設定 -->
                <div class="config-card">
                    <h3>週報排程通知設定</h3>
                    <div class="alert alert-info" style="margin-bottom:10px; font-size: 0.9em;">
                        設定週報通知的收件者與啟用狀態。可使用「測試週報寄送」驗證設定是否正確。
                    </div>
                    <div class="form-group">
                        <label>通知總開關</label>
                        <select id="notifEnabled">
                            <option value="true">啟用</option>
                            <option value="false">停用</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Email 通知</label>
                        <select id="emailEnabledWeekly">
                            <option value="false">停用</option>
                            <option value="true">啟用</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>CISO Email</label>
                        <input type="email" id="emailCISOWeekly" placeholder="ciso@company.com">
                    </div>
                    <div class="form-group">
                        <label>IT 團隊 Email</label>
                        <input type="email" id="emailITWeekly" placeholder="it@company.com">
                    </div>
                    <div class="form-group">
                        <label>週報收件者</label>
                        <div class="checkbox-group">
                            <div class="checkbox-item">
                                <label><input type="checkbox" id="typeWeeklyCISOConfig"> CISO</label>
                                <label><input type="checkbox" id="typeWeeklyITConfig"> IT</label>
                            </div>
                        </div>
                    </div>
                    <div style="display:flex; gap:10px; margin-top:10px;">
                        <button class="btn btn-primary" onclick="saveWeeklyNotificationConfig()">儲存週報通知設定</button>
                        <button class="btn btn-success" onclick="testSendWeekly()">測試週報寄送</button>
                    </div>
                </div>
            </div>

            <!-- 手動立即觸發按鈕 -->
            <div class="config-card" style="margin-top: 20px;">
                <h3>手動立即觸發</h3>
                <div class="btn-group">
                    <button class="btn btn-success" onclick="triggerCollectors()">觸發收集任務</button>
                    <button class="btn btn-success" onclick="triggerCorrelation()">觸發關聯分析</button>
                    <button class="btn btn-success" onclick="triggerAll()">觸發全部（收集+分析）</button>
                </div>
            </div>
            </div>
            </div>
        </div>

        <!-- 頁籤 2：處理狀態與報告 -->
        <div id="status-tab" class="tab-content">
            <div class="bottom-section" style="padding: 0; background: transparent; border: none;">
            <div class="status-grid">
                <!-- 收集任務狀態 -->
                <div class="status-card">
                    <h3>收集任務與關聯分析</h3>
                    <div>
                        <span class="status-indicator status-idle" id="collectorsStatus">閒置</span>
                        <div class="timestamp" id="collectorsTimestamp"></div>
                    </div>
                    <div id="collectorsMessage"></div>
                    <div class="log-container" id="collectorsLogs"></div>
                </div>

                <!-- 關聯分析狀態 -->
                <div class="status-card">
                    <h3>關聯分析狀態</h3>
                    <div>
                        <span class="status-indicator status-idle" id="correlationStatus">閒置</span>
                        <div class="timestamp" id="correlationTimestamp"></div>
                    </div>
                    <div id="correlationMessage"></div>
                    <div class="log-container" id="correlationLogs"></div>
                </div>

                <!-- 報告生成 -->
                <div class="status-card">
                    <h3>報告生成</h3>
                    <div style="margin-bottom: 10px; padding: 8px; background-color: #f0f0f0; border-radius: 4px; font-size: 0.9em; color: #666;">
                        <strong>說明：</strong>報告類型用於生成不同格式的報告檔案。<br>
                        • <strong>CISO 週報</strong>：管理層週報，包含威脅摘要、風險分析、建議措施（HTML/PDF 格式）<br>
                        • <strong>IT 工單</strong>：技術層工單，包含具體的威脅資訊、受影響資產、修補建議（TEXT/JSON 格式）
                    </div>
                    <div>
                        <span class="status-indicator status-idle" id="report_generationStatus">閒置</span>
                        <div class="timestamp" id="report_generationTimestamp"></div>
                    </div>
                    <div id="report_generationMessage"></div>
                    <div class="log-container" id="report_generationLogs" style="max-height: 200px; overflow-y: auto; margin-top: 10px; padding: 10px; background: #f5f5f5; border-radius: 5px; font-size: 0.9em;"></div>
                    <div id="reportFilepath" style="margin-top: 10px;"></div>
                    
                    <div class="report-options">
                        <div class="form-group">
                            <label>報告類型</label>
                            <select id="reportType">
                                <option value="ciso_weekly">CISO 週報</option>
                                <option value="it_ticket">IT 工單</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>檔案格式</label>
                            <select id="reportFormat">
                                <option value="html">HTML</option>
                                <option value="json">JSON</option>
                                <option value="text">TEXT</option>
                            </select>
                        </div>
                    </div>
                    <button class="btn btn-primary" onclick="generateReport()">生成報告</button>
                    <div id="reportFilepath" style="margin-top: 10px; font-size: 0.9em; color: #666;"></div>
                </div>
            </div>

            <!-- 週報排程監視 - 滿版寬度 -->
            <div class="status-card" style="grid-column: 1 / -1; width: 100%;">
                <h3>週報排程監視</h3>
                <div style="margin-bottom:10px">
                    <button class="btn btn-primary" onclick="refreshWeeklyJobs()">重新整理</button>
                    <button class="btn btn-success" onclick="testSendWeekly()">測試寄送（使用最新報告）</button>
                </div>
                <div id="weeklyJobsSummary" class="alert alert-info" style="display:none;"></div>
                <div class="log-container" style="max-height: 300px;">
                    <table style="width:100%; border-collapse: collapse;">
                        <thead>
                            <tr>
                                <th style="text-align:left; padding:6px;">時間</th>
                                <th style="text-align:left; padding:6px;">階段</th>
                                <th style="text-align:left; padding:6px;">狀態</th>
                                <th style="text-align:left; padding:6px;">收件者</th>
                                <th style="text-align:left; padding:6px;">訊息</th>
                            </tr>
                        </thead>
                        <tbody id="weeklyJobsBody"></tbody>
                    </table>
                </div>
            </div>
            </div>
        </div>
    </div>

    <script>
        // 頁籤切換功能
        function switchTab(tabName) {
            // 隱藏所有頁籤內容
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // 移除所有按鈕的 active 狀態
            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // 顯示選中的頁籤內容
            if (tabName === 'settings') {
                document.getElementById('settings-tab').classList.add('active');
                document.querySelectorAll('.tab-button')[0].classList.add('active');
            } else if (tabName === 'status') {
                document.getElementById('status-tab').classList.add('active');
                document.querySelectorAll('.tab-button')[1].classList.add('active');
            }
        }

        // 更新日期時間
        function updateDateTime() {
            const now = new Date();
            const options = {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit',
                hour12: false,
                timeZone: 'Asia/Taipei'
            };
            const dateTimeStr = now.toLocaleString('zh-TW', options);
            document.getElementById('datetime').textContent = dateTimeStr;
        }

        // 每秒更新時間
        setInterval(updateDateTime, 1000);
        updateDateTime();

        // 更新排程設定
        async function updateScheduler() {
            const hours = document.getElementById('intervalHours').value;
            const minutes = document.getElementById('intervalMinutes').value;

            try {
                const response = await fetch('/api/config', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        scheduler: {
                            interval: {
                                hours: hours ? parseInt(hours) : null,
                                minutes: minutes ? parseInt(minutes) : null
                            }
                        }
                    })
                });

                const data = await response.json();
                if (data.success) {
                    alert('排程設定已更新');
                } else {
                    alert('更新失敗：' + data.error);
                }
            } catch (error) {
                alert('更新失敗：' + error.message);
            }
        }

        // 更新週報排程
        async function updateWeeklySchedule() {
            const day = document.getElementById('weeklyDay').value;
            const hour = parseInt(document.getElementById('weeklyHour').value, 10);
            const minute = parseInt(document.getElementById('weeklyMinute').value, 10);

            if (!['mon','tue','wed','thu','fri','sat','sun'].includes(day)) {
                alert('星期選擇不合法');
                return;
            }
            if (isNaN(hour) || hour < 0 || hour > 23) {
                alert('小時需為 0-23');
                return;
            }
            if (isNaN(minute) || minute < 0 || minute > 59) {
                alert('分鐘需為 0-59');
                return;
            }

            try {
                const response = await fetch('/api/config', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        reporting: {
                            weekly_report: {
                                enabled: true,
                                schedule_struct: {
                                    day_of_week: day,
                                    hour: hour,
                                    minute: minute
                                }
                            }
                        }
                    })
                });
                const data = await response.json();
                if (data.success) {
                    alert('週報排程已更新，將即時重排程生效');
                } else {
                    alert('更新失敗：' + data.error);
                }
            } catch (error) {
                alert('更新失敗：' + error.message);
            }
        }

        // 更新通知設定（只更新收件者設定）
        async function updateNotification() {
            const notifEnabled = document.getElementById('notifEnabled').value === 'true';
            const emailEnabled = document.getElementById('emailEnabled').value === 'true';
            const emailCISO = document.getElementById('emailCISO').value;
            const emailIT = document.getElementById('emailIT').value;
            // 收件群組映射
            const typeCritical = [];
            if (document.getElementById('typeCriticalCISO').checked) typeCritical.push('ciso');
            if (document.getElementById('typeCriticalIT').checked) typeCritical.push('it');
            const typeHigh = [];
            if (document.getElementById('typeHighCISO').checked) typeHigh.push('ciso');
            if (document.getElementById('typeHighIT').checked) typeHigh.push('it');
            const typeWeekly = [];
            if (document.getElementById('typeWeeklyCISO').checked) typeWeekly.push('ciso');
            if (document.getElementById('typeWeeklyIT').checked) typeWeekly.push('it');

            try {
                const response = await fetch('/api/config', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        notification: {
                            enabled: notifEnabled,
                            email: {
                                enabled: emailEnabled,
                                ciso_email: emailCISO,
                                it_email: emailIT
                            },
                            recipients: {
                                ciso: emailCISO,
                                it: emailIT
                            },
                            types: {
                                critical: { enabled: true, recipients: typeCritical },
                                high_daily: { enabled: true, recipients: typeHigh },
                                weekly_report: { enabled: true, recipients: typeWeekly }
                            }
                        }
                    })
                });

                const data = await response.json();
                if (data.success) {
                    alert('通知設定已更新');
                } else {
                    alert('更新失敗：' + data.error);
                }
            } catch (error) {
                alert('更新失敗：' + error.message);
            }
        }

        // 更新 SMTP 設定
        async function updateSMTP() {
            const smtpServer = document.getElementById('smtpServer').value;
            const smtpPort = document.getElementById('smtpPort').value;
            const smtpUsername = document.getElementById('smtpUsername').value;
            const smtpPassword = document.getElementById('smtpPassword').value;
            const emailFrom = document.getElementById('emailFrom').value;
            const smtpUseTLS = document.getElementById('smtpUseTLS').value === 'true';

            try {
                const response = await fetch('/api/config', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        notification: {
                            email: {
                                smtp_server: smtpServer,
                                smtp_port: smtpPort ? parseInt(smtpPort) : null,
                                smtp_username: smtpUsername,
                                smtp_password: smtpPassword,
                                from_address: emailFrom,
                                use_tls: smtpUseTLS
                            }
                        }
                    })
                });

                const data = await response.json();
                if (data.success) {
                    alert('SMTP 設定已更新');
                } else {
                    alert('更新失敗：' + data.error);
                }
            } catch (error) {
                alert('更新失敗：' + error.message);
            }
        }

        // 儲存週報通知設定
        async function saveWeeklyNotificationConfig() {
            const notifEnabled = document.getElementById('notifEnabled').value === 'true';
            const emailEnabled = document.getElementById('emailEnabledWeekly').value === 'true';
            const emailCISO = document.getElementById('emailCISOWeekly').value;
            const emailIT = document.getElementById('emailITWeekly').value;
            
            // 週報收件者
            const typeWeekly = [];
            if (document.getElementById('typeWeeklyCISOConfig').checked) typeWeekly.push('ciso');
            if (document.getElementById('typeWeeklyITConfig').checked) typeWeekly.push('it');

            try {
                // 先讀取當前設定，確保保留 SMTP 設定
                const getConfigResponse = await fetch('/api/config');
                const getConfigData = await getConfigResponse.json();
                
                if (!getConfigData.success) {
                    alert('無法讀取當前設定：' + getConfigData.error);
                    return;
                }
                
                const currentConfig = getConfigData.config;
                const currentEmailConfig = currentConfig.notification?.email || {};
                
                // 只更新需要的欄位，保留 SMTP 設定不變
                const emailUpdate = {
                    enabled: emailEnabled,
                    ciso_email: emailCISO,
                    it_email: emailIT
                };
                
                // 保留所有 SMTP 相關設定（確保不會被清空）
                // 使用 hasOwnProperty 檢查欄位是否存在，即使值為空也保留
                if (currentEmailConfig.hasOwnProperty('smtp_server')) {
                    emailUpdate.smtp_server = currentEmailConfig.smtp_server;
                }
                if (currentEmailConfig.hasOwnProperty('smtp_port')) {
                    emailUpdate.smtp_port = currentEmailConfig.smtp_port;
                }
                if (currentEmailConfig.hasOwnProperty('smtp_username')) {
                    emailUpdate.smtp_username = currentEmailConfig.smtp_username;
                }
                // 密碼處理：
                // - 如果是加密字串或環境變數，保留原值
                // - 如果是 '***'（明碼被隱藏），不包含在更新中，讓後端保留原值
                if (currentEmailConfig.hasOwnProperty('smtp_password') && 
                    currentEmailConfig.smtp_password !== '***' &&
                    currentEmailConfig.smtp_password !== null &&
                    currentEmailConfig.smtp_password !== undefined) {
                    // 只保留加密或環境變數格式的密碼
                    if (currentEmailConfig.smtp_password.startsWith('ENCRYPTED:') || 
                        currentEmailConfig.smtp_password.startsWith('${')) {
                        emailUpdate.smtp_password = currentEmailConfig.smtp_password;
                    }
                    // 如果是明碼，不包含在更新中（由後端保留原值）
                }
                if (currentEmailConfig.hasOwnProperty('from_address')) {
                    emailUpdate.from_address = currentEmailConfig.from_address;
                }
                if (currentEmailConfig.hasOwnProperty('use_tls')) {
                    emailUpdate.use_tls = currentEmailConfig.use_tls;
                }

                const response = await fetch('/api/config', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        notification: {
                            enabled: notifEnabled,
                            email: emailUpdate,
                            recipients: {
                                ciso: emailCISO,
                                it: emailIT
                            },
                            types: {
                                weekly_report: {
                                    enabled: true,
                                    recipients: typeWeekly
                                }
                            }
                        }
                    })
                });

                const data = await response.json();
                if (data.success) {
                    alert('週報通知設定已更新');
                    loadConfig(); // 重新載入設定以同步顯示
                } else {
                    alert('更新失敗：' + data.error);
                }
            } catch (error) {
                alert('更新失敗：' + error.message);
            }
        }

        // 測試 SMTP 連線
        async function testSMTP() {
            const smtpServer = document.getElementById('smtpServer').value;
            const smtpPort = document.getElementById('smtpPort').value;
            const smtpUsername = document.getElementById('smtpUsername').value;
            const smtpPassword = document.getElementById('smtpPassword').value;
            const emailFrom = document.getElementById('emailFrom').value;
            const smtpUseTLS = document.getElementById('smtpUseTLS').value === 'true';

            // 驗證必填欄位
            if (!smtpServer || !smtpPort || !smtpUsername || !smtpPassword || !emailFrom) {
                alert('請填寫所有 SMTP 設定欄位');
                return;
            }

            // 創建測試視窗
            const testWindow = window.open('', 'SMTP測試', 'width=600,height=500,scrollbars=yes');
            if (!testWindow) {
                alert('無法開啟測試視窗，請允許彈出視窗');
                return;
            }

            testWindow.document.write(`
                <html>
                <head>
                    <title>SMTP 測試</title>
                    <style>
                        body { font-family: Arial, sans-serif; padding: 20px; }
                        .log { background: #f5f5f5; padding: 10px; margin: 10px 0; border-radius: 5px; font-family: monospace; font-size: 12px; }
                        .success { color: green; }
                        .error { color: red; }
                        .info { color: blue; }
                    </style>
                </head>
                <body>
                    <h2>SMTP 測試進行中...</h2>
                    <div id="logs"></div>
                </body>
                </html>
            `);

            function addLog(message, type = 'info') {
                const logsDiv = testWindow.document.getElementById('logs');
                const logDiv = testWindow.document.createElement('div');
                logDiv.className = 'log ' + type;
                logDiv.textContent = new Date().toLocaleTimeString() + ' - ' + message;
                logsDiv.appendChild(logDiv);
                testWindow.scrollTo(0, testWindow.document.body.scrollHeight);
            }

            try {
                addLog('開始測試 SMTP 連線...', 'info');
                addLog(`SMTP 伺服器：${smtpServer}`, 'info');
                addLog(`SMTP 埠口：${smtpPort}`, 'info');
                addLog(`使用者名稱：${smtpUsername}`, 'info');
                addLog(`發送者 Email：${emailFrom}`, 'info');
                addLog(`使用 TLS：${smtpUseTLS}`, 'info');

                const response = await fetch('/api/smtp/test', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        smtp_server: smtpServer,
                        smtp_port: parseInt(smtpPort),
                        smtp_username: smtpUsername,
                        smtp_password: smtpPassword,
                        from_address: emailFrom,
                        to_address: emailFrom,  // 測試時發送給自己
                        use_tls: smtpUseTLS
                    })
                });

                const data = await response.json();
                
                if (data.success) {
                    addLog('✓ SMTP 連線成功！', 'success');
                    addLog('✓ 認證成功！', 'success');
                    addLog('✓ 測試 Email 已發送至：' + emailFrom, 'success');
                    addLog('', 'info');
                    addLog('測試完成！請檢查您的收件匣。', 'success');
                } else {
                    addLog('✗ SMTP 測試失敗', 'error');
                    addLog('錯誤訊息：' + (data.error || '未知錯誤'), 'error');
                    if (data.details) {
                        addLog('詳細資訊：' + data.details, 'error');
                    }
                }
            } catch (error) {
                addLog('✗ 測試過程中發生錯誤', 'error');
                addLog('錯誤訊息：' + error.message, 'error');
            }
        }

        // 觸發收集任務
        async function triggerCollectors() {
            try {
                const response = await fetch('/api/trigger/collectors', {
                    method: 'POST'
                });
                const data = await response.json();
                if (data.success) {
                    alert('收集任務已啟動');
                    updateStatus();
                    // 重新計算倒數時間
                    setTimeout(updateCountdown, 1000);
                } else {
                    alert('啟動失敗：' + data.error);
                }
            } catch (error) {
                alert('啟動失敗：' + error.message);
            }
        }

        // 觸發關聯分析
        async function triggerCorrelation() {
            try {
                const response = await fetch('/api/trigger/correlation', {
                    method: 'POST'
                });
                const data = await response.json();
                if (data.success) {
                    alert('關聯分析已啟動');
                    updateStatus();
                } else {
                    alert('啟動失敗：' + data.error);
                }
            } catch (error) {
                alert('啟動失敗：' + error.message);
            }
        }

        // 觸發全部
        async function triggerAll() {
            try {
                const response = await fetch('/api/trigger/all', {
                    method: 'POST'
                });
                const data = await response.json();
                if (data.success) {
                    alert('收集與關聯分析任務已啟動');
                    updateStatus();
                    // 重新計算倒數時間
                    setTimeout(updateCountdown, 1000);
                } else {
                    alert('啟動失敗：' + data.error);
                }
            } catch (error) {
                alert('啟動失敗：' + error.message);
            }
        }

        // 生成報告
        async function generateReport() {
            const reportType = document.getElementById('reportType').value;
            const reportFormat = document.getElementById('reportFormat').value;

            try {
                const response = await fetch('/api/report/generate', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        type: reportType,
                        format: reportFormat
                    })
                });
                const data = await response.json();
                if (data.success) {
                    alert('報告生成任務已啟動');
                    updateStatus();
                } else {
                    alert('啟動失敗：' + data.error);
                }
            } catch (error) {
                alert('啟動失敗：' + error.message);
            }
        }

        // 發送通知
        async function sendNotification() {
            const notificationType = document.getElementById('notificationType').value;
            const recipients = [];
            const recipientEmails = [];
            
            if (document.getElementById('recipientCISO').checked) {
                recipients.push('ciso');
                const emailCISO = document.getElementById('emailCISO').value;
                if (emailCISO) {
                    recipientEmails.push(emailCISO);
                }
            }
            if (document.getElementById('recipientIT').checked) {
                recipients.push('it');
                const emailIT = document.getElementById('emailIT').value;
                if (emailIT) {
                    recipientEmails.push(emailIT);
                }
            }
            
            if (recipients.length === 0) {
                alert('請至少選擇一個收件者');
                return;
            }
            
            if (recipientEmails.length === 0) {
                alert('請先設定收件者 Email');
                return;
            }

            try {
                const response = await fetch('/api/notification/send', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        type: notificationType,
                        recipients: recipients
                    })
                });
                const data = await response.json();
                if (data.success) {
                    alert('通知發送任務已啟動\n收件者：' + recipientEmails.join(', '));
                    updateStatus();
                } else {
                    alert('啟動失敗：' + data.error);
                }
            } catch (error) {
                alert('啟動失敗：' + error.message);
            }
        }

        // 更新狀態
        async function updateStatus() {
            try {
                const response = await fetch('/api/status');
                const data = await response.json();
                
                if (data.success) {
                    const status = data.status;
                    
                    // 更新收集任務狀態
                    updateTaskStatus('collectors', status.collectors);
                    
                    // 更新關聯分析狀態
                    updateTaskStatus('correlation', status.correlation);
                    
                    // 更新報告生成狀態
                    updateTaskStatus('report_generation', status.report_generation);
                    
                    // 更新通知狀態
                    updateTaskStatus('notification', status.notification);
                }
            } catch (error) {
                console.error('更新狀態失敗：', error);
            }
        }

        // 更新任務狀態顯示
        function updateTaskStatus(prefix, taskStatus) {
            const statusEl = document.getElementById(prefix + 'Status');
            const messageEl = document.getElementById(prefix + 'Message');
            const timestampEl = document.getElementById(prefix + 'Timestamp');
            
            // 更新狀態指示器
            statusEl.className = 'status-indicator status-' + taskStatus.status;
            statusEl.textContent = getStatusText(taskStatus.status);
            
            // 更新訊息
            if (messageEl) {
                if (taskStatus.message) {
                    messageEl.innerHTML = '<div class="alert alert-info">' + taskStatus.message + '</div>';
                } else {
                    messageEl.innerHTML = '';
                }
            }
            
            // 更新時間戳（使用 Asia/Taipei 時區）
            if (timestampEl && taskStatus.timestamp) {
                const date = new Date(taskStatus.timestamp);
                const dateTimeStr = date.toLocaleString('zh-TW', {
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit',
                    hour12: false,
                    timeZone: 'Asia/Taipei'
                });
                timestampEl.textContent = '時間：' + dateTimeStr;
            }
            
            // 更新日誌
            if (taskStatus.logs && taskStatus.logs.length > 0) {
                const logsEl = document.getElementById(prefix + 'Logs');
                if (logsEl) {
                    logsEl.innerHTML = taskStatus.logs.map(log => 
                        '<div class="log-entry">' + log + '</div>'
                    ).join('');
                    logsEl.scrollTop = logsEl.scrollHeight;
                }
            }
            
            // 更新報告檔案路徑（使用藍色高亮框顯示，自動折行）
            if (prefix === 'report_generation' && taskStatus.filepath) {
                const messageEl = document.getElementById(prefix + 'Message');
                if (messageEl) {
                    // 如果已經有訊息，追加檔案路徑；否則創建新的訊息框
                    const filepathMsg = '<div class="alert alert-info" style="margin-top: 10px; word-wrap: break-word; word-break: break-all; white-space: pre-wrap;">檔案：' + taskStatus.filepath + '</div>';
                    if (messageEl.innerHTML && !messageEl.innerHTML.includes('檔案：')) {
                        messageEl.innerHTML += filepathMsg;
                    } else if (!messageEl.innerHTML) {
                        messageEl.innerHTML = filepathMsg;
                    }
                }
            }
            
            // 更新通知結果
            if (prefix === 'notification' && taskStatus.result) {
                const resultEl = document.getElementById('notificationResult');
                if (resultEl) {
                    const alertClass = taskStatus.result === 'success' ? 'alert-success' : 'alert-error';
                    resultEl.innerHTML = '<div class="alert ' + alertClass + '">' + 
                        (taskStatus.result === 'success' ? '通知發送成功' : '通知發送失敗') + 
                        '</div>';
                }
            }
        }

        // 取得狀態文字
        function getStatusText(status) {
            const statusMap = {
                'idle': '閒置',
                'running': '執行中',
                'completed': '已完成',
                'error': '錯誤'
            };
            return statusMap[status] || status;
        }

        // 更新倒數時間
        async function updateCountdown() {
            try {
                const response = await fetch('/api/scheduler/next-run');
                const data = await response.json();
                
                if (data.success) {
                    const nextRunTimeEl = document.getElementById('nextRunTime');
                    if (nextRunTimeEl) {
                        if (data.countdown_seconds > 0) {
                            nextRunTimeEl.value = data.countdown_str;
                        } else {
                            nextRunTimeEl.value = '即將執行';
                        }
                    }
                } else {
                    const nextRunTimeEl = document.getElementById('nextRunTime');
                    if (nextRunTimeEl) {
                        nextRunTimeEl.value = '計算中...';
                    }
                }
            } catch (error) {
                console.error('更新倒數時間失敗：', error);
                const nextRunTimeEl = document.getElementById('nextRunTime');
                if (nextRunTimeEl) {
                    nextRunTimeEl.value = '計算中...';
                }
            }
        }
        
        // 更新排程設定
        async function updateScheduler() {
            const hours = document.getElementById('intervalHours').value;
            const minutes = document.getElementById('intervalMinutes').value;
            
            // 驗證：小時和分鐘不能同時不使用
            if (!hours && !minutes) {
                alert('錯誤：小時和分鐘不能同時選擇「不使用」，請至少選擇一個。');
                return;
            }
            
            try {
                const response = await fetch('/api/config', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        scheduler: {
                            interval: {
                                hours: hours ? parseInt(hours) : null,
                                minutes: minutes ? parseInt(minutes) : null
                            }
                        }
                    })
                });
                
                const data = await response.json();
                if (data.success) {
                    alert('排程設定已更新');
                    // 重新計算倒數時間
                    updateCountdown();
                    // 每 10 秒更新一次倒數時間
                    setTimeout(updateCountdown, 100);
                } else {
                    alert('更新失敗：' + data.error);
                }
            } catch (error) {
                alert('更新失敗：' + error.message);
            }
        }

        // 定期更新狀態
        // 測試環境：每 2 秒更新（即時性優先）
        // 生產環境：建議調整為 5-10 秒（平衡效能和即時性）
        // 可根據需求修改此數值：2000 = 2秒, 5000 = 5秒, 10000 = 10秒
        const STATUS_UPDATE_INTERVAL = 2000;  // 狀態更新間隔（毫秒）
        setInterval(updateStatus, STATUS_UPDATE_INTERVAL);
        updateStatus();
        
        // 定期更新倒數時間
        // 時間變化較慢，不需要太頻繁更新
        // 可根據需求修改此數值：10000 = 10秒, 30000 = 30秒, 60000 = 60秒
        const COUNTDOWN_UPDATE_INTERVAL = 10000;  // 倒數時間更新間隔（毫秒）
        setInterval(updateCountdown, COUNTDOWN_UPDATE_INTERVAL);
        updateCountdown();

        // Weekly Jobs Monitor
        async function refreshWeeklyJobs() {
            try {
                const res = await fetch('/api/weekly-jobs?limit=20');
                const data = await res.json();
                const body = document.getElementById('weeklyJobsBody');
                body.innerHTML = '';
                if (data.success && Array.isArray(data.items)) {
                    const items = data.items;
                    if (items.length > 0) {
                        const latest = items[0];
                        const summary = document.getElementById('weeklyJobsSummary');
                        summary.style.display = 'block';
                        summary.innerText = `最近一次：${(latest.triggered_at || latest.updated_at || '').replace('T',' ').slice(0,19)} - ${latest.status || 'N/A'} - ${latest.message || ''}`;
                    }
                    for (const it of items) {
                        const tr = document.createElement('tr');
                        const time = (it.triggered_at || it.updated_at || '').replace('T',' ').slice(0,19);
                        const recips = (it.recipients || []).join(', ');
                        tr.innerHTML = `
                            <td style="padding:6px;">${time}</td>
                            <td style="padding:6px;">${it.phase || ''}</td>
                            <td style="padding:6px;">${it.status || ''}</td>
                            <td style="padding:6px;">${recips}</td>
                            <td style="padding:6px;">${it.message || ''}</td>
                        `;
                        body.appendChild(tr);
                    }
                }
            } catch (e) {
                console.error('refreshWeeklyJobs error', e);
            }
        }

        async function testSendWeekly() {
            const to = prompt('輸入測試收件者（留空使用 config.to_address）：', '');
            try {
                const res = await fetch('/api/weekly-jobs/test-send', {
                    method: 'POST',
                    headers: {'Content-Type':'application/json'},
                    body: JSON.stringify({ to: to || undefined })
                });
                const data = await res.json();
                if (data.success) {
                    alert('已觸發測試寄送：' + data.report);
                } else {
                    alert('測試寄送失敗：' + data.error);
                }
            } catch (e) {
                alert('測試寄送失敗：' + e.message);
            }
        }

        // 定時刷新週報監視
        setInterval(refreshWeeklyJobs, 5000);
        refreshWeeklyJobs();

        // 載入設定
        async function loadConfig() {
            try {
                const response = await fetch('/api/config');
                const data = await response.json();
                
                if (data.success && data.config) {
                    const config = data.config;
                    
                    // 載入排程設定
                    if (config.scheduler && config.scheduler.interval) {
                        if (config.scheduler.interval.hours) {
                            document.getElementById('intervalHours').value = config.scheduler.interval.hours;
                        }
                        if (config.scheduler.interval.minutes) {
                            document.getElementById('intervalMinutes').value = config.scheduler.interval.minutes;
                        }
                    }

                    // 載入週報排程設定（結構化＋相容）
                    try {
                        const weekly = (config.reporting && config.reporting.weekly_report) ? config.reporting.weekly_report : {};
                        const scheduleStruct = weekly.schedule_struct;
                        if (scheduleStruct) {
                            if (scheduleStruct.day_of_week) document.getElementById('weeklyDay').value = scheduleStruct.day_of_week;
                            if (Number.isInteger(scheduleStruct.hour)) document.getElementById('weeklyHour').value = scheduleStruct.hour;
                            if (Number.isInteger(scheduleStruct.minute)) document.getElementById('weeklyMinute').value = scheduleStruct.minute;
                        } else if (weekly.schedule) {
                            // 相容：解析 "monday 08:00"
                            const map = {'monday':'mon','tuesday':'tue','wednesday':'wed','thursday':'thu','friday':'fri','saturday':'sat','sunday':'sun'};
                            const parts = weekly.schedule.trim().split(/\s+/);
                            if (parts.length === 2) {
                                const d = map[parts[0].toLowerCase()] || parts[0].toLowerCase();
                                const hm = parts[1].split(':');
                                const h = parseInt(hm[0], 10);
                                const m = parseInt(hm[1], 10);
                                if (['mon','tue','wed','thu','fri','sat','sun'].includes(d)) document.getElementById('weeklyDay').value = d;
                                if (!isNaN(h)) document.getElementById('weeklyHour').value = h;
                                if (!isNaN(m)) document.getElementById('weeklyMinute').value = m;
                            }
                        }
                    } catch (e) {
                        console.warn('載入週報排程設定失敗：', e);
                    }
                    
                    // 載入通知設定（僅載入週報通知設定）
                    if (config.notification && config.notification.email) {
                        // 載入 SMTP 設定
                        if (config.notification.email.smtp_server) {
                            document.getElementById('smtpServer').value = config.notification.email.smtp_server;
                        }
                        if (config.notification.email.smtp_port) {
                            document.getElementById('smtpPort').value = config.notification.email.smtp_port;
                        }
                        if (config.notification.email.smtp_username) {
                            document.getElementById('smtpUsername').value = config.notification.email.smtp_username;
                        }
                        // 密碼欄位：如果是加密字串或環境變數，顯示提示；否則留空（不顯示明碼）
                        if (config.notification.email.smtp_password) {
                            const passwordValue = config.notification.email.smtp_password;
                            if (passwordValue.startsWith('ENCRYPTED:') || passwordValue.startsWith('${')) {
                                // 加密字串或環境變數，不顯示實際值，只顯示提示
                                document.getElementById('smtpPassword').value = '';
                                document.getElementById('smtpPassword').placeholder = '密碼已設定（加密或環境變數）';
                            } else if (passwordValue !== '***') {
                                // 明碼或解密後的密碼，不顯示實際值
                                document.getElementById('smtpPassword').value = '';
                                document.getElementById('smtpPassword').placeholder = '密碼已設定（請輸入新密碼以更新）';
                            } else {
                                // 已隱藏的密碼
                                document.getElementById('smtpPassword').value = '';
                                document.getElementById('smtpPassword').placeholder = '請輸入密碼';
                            }
                        }
                        if (config.notification.email.from_address) {
                            document.getElementById('emailFrom').value = config.notification.email.from_address;
                        }
                        if (config.notification.email.use_tls !== undefined) {
                            document.getElementById('smtpUseTLS').value = config.notification.email.use_tls ? 'true' : 'false';
                        }
                        // 類型收件者映射
                        const types = (config.notification && config.notification.types) ? config.notification.types : {};
                        const weekly = types.weekly_report || {};
                        const critical = types.critical || {};
                        const high = types.high_daily || {};
                        const has = (arr, who) => Array.isArray(arr) && arr.includes(who);
                        
                        // 載入週報通知設定（新卡片）
                        if (document.getElementById('notifEnabled')) {
                            // 載入通知總開關
                            const notifEnabledValue = config.notification.enabled !== undefined ? config.notification.enabled : true;
                            document.getElementById('notifEnabled').value = notifEnabledValue ? 'true' : 'false';
                        }
                        if (document.getElementById('emailEnabledWeekly')) {
                            document.getElementById('emailEnabledWeekly').value = 
                                config.notification.email.enabled ? 'true' : 'false';
                        }
                        if (document.getElementById('emailCISOWeekly')) {
                            const cisoEmail = config.notification.recipients?.ciso || config.notification.email.ciso_email || config.notification.email.to_address;
                            if (cisoEmail) {
                                document.getElementById('emailCISOWeekly').value = cisoEmail;
                            }
                        }
                        if (document.getElementById('emailITWeekly')) {
                            const itEmail = config.notification.recipients?.it || config.notification.email.it_email || config.notification.email.to_address;
                            if (itEmail) {
                                document.getElementById('emailITWeekly').value = itEmail;
                            }
                        }
                        if (document.getElementById('typeWeeklyCISOConfig')) {
                            document.getElementById('typeWeeklyCISOConfig').checked = has(weekly.recipients, 'ciso');
                        }
                        if (document.getElementById('typeWeeklyITConfig')) {
                            document.getElementById('typeWeeklyITConfig').checked = has(weekly.recipients, 'it');
                        }
                    }
                }
            } catch (error) {
                console.error('載入設定失敗：', error);
            }
        }

        // 頁面載入時載入設定
        loadConfig();
    </script>
</body>
</html>

