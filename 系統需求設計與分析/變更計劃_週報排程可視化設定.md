### 變更計劃：週報排程可視化設定（可在 Web 介面調整）

- 版本：v1.0
- 日期：2025-11-16
- 目標對象：產品負責人、開發、測試、維運

---

#### 1. 背景與目標
- 目前階段三的「CISO 週報」觸發時間固定為每週一 08:00（`scheduler.py` 內寫死 `CronTrigger(day_of_week='mon', hour=8, minute=0)`）。
- 目標：允許使用者在 Web 介面上調整週報生成排程（星期、時、分），即時生效，無需重啟服務。

---

#### 2. 變更範圍（Scope）
- 設定檔結構：`aetim/config.yaml` 新增結構化排程欄位（保留向後相容）。
- 後端 API：`GET /api/config` 與 `POST /api/config` 支援新的排程欄位，並做基本驗證。
- Web 介面：於 `templates/index.html` 新增「週報排程」設定區塊（星期、時、分）。
- 排程器：`aetim/scheduler.py` 改為依設定載入 `CronTrigger`；新增「不重啟重排程」能力。
- 文件：更新 `aetim/README.md` 與需求文件，新增操作說明與驗收流程。

---

#### 3. 設定檔設計（Config Schema）
現況：
```yaml
reporting:
  weekly_report:
    enabled: true
    schedule: monday 08:00
```

新方案（結構化，含相容）：
```yaml
reporting:
  weekly_report:
    enabled: true
    schedule_struct:
      day_of_week: mon     # mon,tue,wed,thu,fri,sat,sun
      hour: 8              # 0-23
      minute: 0            # 0-59
      timezone: Asia/Taipei
```
- 相容策略：
  - 若 `schedule_struct` 缺失但 `schedule` 存在：啟動時解析舊值（如 "monday 08:00" → mon/8/0），運行用解析後結果。
  - 前端保存成功後，回寫 `schedule_struct` 並可移除 `schedule` 舊欄位（或標記為 deprecated）。
- 驗證規則：
  - `day_of_week` ∈ {mon,tue,wed,thu,fri,sat,sun}
  - `hour` ∈ [0,23]，`minute` ∈ [0,59]
  - `timezone` 預設 `Asia/Taipei`（第一版固定，未開放在UI修改）

---

#### 4. Web 介面（UI/UX）
- `templates/index.html` 新增區塊「週報排程」：
  - 選擇星期：下拉選單（mon→sun）
  - 選擇小時：數字輸入或下拉（0-23）
  - 選擇分鐘：數字輸入或下拉（0-59）
  - 操作：按「儲存設定」呼叫 `POST /api/config`
- 顯示目前設定：從 `GET /api/config` 讀取 `schedule_struct` 並填充 UI。
- 錯誤提示：若後端返回 400，顯示欄位錯誤訊息（不更新畫面值）。

---

#### 5. 後端 API 調整
- `GET /api/config`：
  - 回傳 `reporting.weekly_report.schedule_struct`。若僅有舊 `schedule`，後端即時解析為 `schedule_struct` 後回傳（不強制寫回檔）。
- `POST /api/config`（新增驗證與重排程觸發）：
  - 驗證欄位（星期/時/分）格式與範圍，錯誤回 400。
  - 寫回 `config.yaml`。
  - 偵測週報排程有變更時：觸發排程器重載（詳見第 6 節）。

---

#### 6. 排程器設計（即時重排程）
- `aetim/scheduler.py`：
  - 啟動時：優先讀 `schedule_struct` → 建立 `CronTrigger(day_of_week=..., hour=..., minute=..., timezone='Asia/Taipei')`。
  - 新增函式 `reschedule_weekly_report(scheduler)`：
    - 移除既有 `job_weekly_report`
    - 重新讀取 `config.yaml`，依 `schedule_struct` 建立新觸發器
    - 重新加入 weekly job，印出新時間設定
  - 重載觸發方式（首選）：
    - 訊號：監聽 `SIGUSR2`，收到後呼叫 `reschedule_weekly_report`
  - 重載觸發方式（替代）：
    - 若訊號不可用：在 `web_app.py` 寫入一個短暫的「reload旗標檔」，`scheduler.py` 每 30 秒輪詢並執行重排程
  - 第一版採用 `SIGUSR2`；容器內可由 Web 進程發送（同一容器 PID 互見）

---

#### 7. 相容與預設行為
- 若設定缺失或非法：退回預設 `mon 08:00`。
- 若 `reporting.weekly_report.enabled` 為 false：不建立 weekly job。
- 舊欄位 `schedule` 僅用於相容解析，不再在 UI 顯示。

---

#### 8. 測試與驗收
- 單元/整合測試：
  - 驗證 `POST /api/config` 對欄位的合法/非法輸入處理（含 400）。
  - `scheduler.py` 在收到 `SIGUSR2` 後能正確重排程，並印出新的 day/hour/min。
  - 以新設定（例如 wed 09:30）運行到時間點前後，確認任務觸發一次。
- 手動驗收：
  1) 於 UI 將時間改為「週三 09:30」→ 儲存 → 觀察排程器日誌出現「重排程為 wed 09:30」  
  2) 修改回「週一 08:00」→ 同上  
  3) 不合法值（如 hour=25）→ UI 顯示錯誤、後端回 400  
  4) 停用 weekly_report.enabled → 不再建立週報排程

---

#### 9. 風險與緩解
- 訊號不可用：提供旗標檔輪詢替代方案。
- 時區一致性：統一 `Asia/Taipei`；後續如需跨時區再擴充。
- 多進程同步：Web 與 Scheduler 在同容器內以 PID 訊號互通；不同部署拓撲需改為 HTTP 管理端點。

---

#### 10. 上線與文件
- 更新 `aetim/README.md`：新增「在 Web 上變更週報排程」章節與操作截圖位置。
- 更新安裝/維運手冊：加入訊號重載說明與故障排除（看不到重載日誌時的處理）。


