# AETIM 專案問題修改清單

**文件版本**：v1.0  
**最後更新**：2025年11月6日  
**專案名稱**：AI 驅動之自動化威脅情資管理系統 (AETIM)

---

## 說明

本文件記錄 AETIM 專案開發過程中發現並已解決的問題，依時間順序排列。

---

## 問題修改清單（依時間順序）

### 2025年11月6日 - Web 界面問題修正

#### 問題 1：下次執行時間顯示異常
**發現時間**：2025年11月6日  
**問題描述**：
- 排程狀態為「啟用」，但「下次執行時間」一直顯示「計算中...」，沒有顯示倒數時間
- 下次執行時間未在動態排程設定修改、服務重新啟動或手動觸發後更新

**解決方案**：
- 實作 `GET /api/scheduler/next-run` API 端點，計算並返回下次執行時間和倒數時間
- 修改前端 JavaScript，實作 `updateCountdown()` 函數，定期更新倒數時間
- 在 `trigger_collectors`、`trigger_correlation`、`trigger_all` 函數中更新 `scheduler_state['last_execution_time']`
- 在 `update_config` 中重置 `scheduler_state['last_execution_time']` 當排程設定變更時

**修改檔案**：
- `aetim/web_app.py`：新增 `scheduler_state` 全域字典、`GET /api/scheduler/next-run` 端點
- `aetim/templates/index.html`：新增 `updateCountdown()` 函數和定期更新機制

---

#### 問題 2：動態排程設定功能不完整
**發現時間**：2025年11月6日  
**問題描述**：
- 執行間隔（小時）缺少「不使用」選項
- 動態排程間隔時間計算邏輯不正確（應為小時＋分鐘）
- 小時和分鐘不能同時選擇「不使用」

**解決方案**：
- 在執行間隔（小時）下拉選單中新增「不使用」選項
- 修改排程計算邏輯：當小時選擇「不使用」時，僅使用分鐘；當分鐘選擇「不使用」時，僅使用小時
- 實作驗證規則：小時和分鐘不能同時選擇「不使用」
- 將動態排程設定改為並排顯示（小時和分鐘在同一行）

**修改檔案**：
- `aetim/templates/index.html`：修改動態排程設定 UI 和驗證邏輯
- `aetim/web_app.py`：更新排程計算邏輯

---

#### 問題 3：通知人員設定功能限制
**發現時間**：2025年11月6日  
**問題描述**：
- 只能設定一個收件者 Email 帳號，無法分別設定 CISO 或 IT 團隊不同的收件者
- 發送通知後，提示視窗未顯示收件者 Email

**解決方案**：
- 將通知人員設定區分為「CISO Email」和「IT 團隊 Email」兩個獨立欄位
- 修改 `updateNotification()` 函數，支援分別設定 `ciso_email` 和 `it_email`
- 在發送通知的提示視窗中顯示收件者 Email 地址

**修改檔案**：
- `aetim/templates/index.html`：新增 CISO Email 和 IT Email 輸入欄位
- `aetim/web_app.py`：更新 `update_config` 函數處理多收件者設定

---

#### 問題 4：Email 通知未收到
**發現時間**：2025年11月6日  
**問題描述**：
- UI 顯示「已完成」和「通知發送完成」，但實際未收到 Email
- 日誌顯示「通知功能未啟用，跳過週報發送」

**解決方案**：
- 將 SMTP 設定從通知人員設定區獨立出來，建立獨立的「SMTP 設定」區塊
- 新增「測試 SMTP」按鈕，可測試 SMTP 連線和寄送功能
- 新增 SMTP 設定欄位：伺服器、埠口、使用者名稱、密碼、發送者 Email、TLS 設定
- 修改 `notify_weekly_report` 函數邏輯，優先檢查 `email.enabled` 而不是 `notification.enabled`
- 確保傳遞 config 時設定 `notification.enabled = True` 和 `email.enabled = True`

**修改檔案**：
- `aetim/templates/index.html`：新增 SMTP 設定區塊和測試功能
- `aetim/web_app.py`：新增 `POST /api/smtp/test` 端點，更新設定處理邏輯
- `aetim/notification_handler.py`：修改通知啟用檢查邏輯

---

#### 問題 5：處理狀態與報告顯示問題
**發現時間**：2025年11月6日  
**問題描述**：
- 手動按「觸發全部」無法看到詳細訊息狀態，只顯示「開始執行所有收集器...」和「開始關聯分析...」
- 報告生成過程中沒有進度訊息，一直顯示「閒置」
- 選擇報告類型「IT 工單」沒有產生報告檔案

**解決方案**：
- 增強 `trigger_all` 函數的日誌輸出，提供每個收集器任務的詳細訊息
- 修改報告生成狀態追蹤，確保狀態正確更新
- 實作 IT 工單報告生成邏輯，支援 Text 和 JSON 格式

**修改檔案**：
- `aetim/web_app.py`：增強 `trigger_all` 函數的日誌輸出
- `aetim/reporting_engine.py`：實作 IT 工單報告生成功能
- `aetim/templates/index.html`：修正報告狀態顯示元素 ID

---

### 2025年11月6日 - 系統啟動與通知功能修正

#### 問題 6：Docker 自動啟動問題
**發現時間**：2025年11月6日  
**問題描述**：
- 電腦啟動後，Docker 不會自動啟動
- aetim 容器服務不會自動啟動
- 服務啟動後，排程狀態為啟用時，不會立即觸發全部任務

**解決方案**：
- 在 `docker-compose.yml` 中為兩個服務新增 `restart: unless-stopped` 設定
- 實作 `startup_tasks()` 函數，在 `web_app.py` 啟動時自動執行
- 當排程狀態為啟用時，自動觸發收集＋分析＋CISO 報告生成

**修改檔案**：
- `aetim/docker-compose.yml`：新增 `restart: unless-stopped` 設定
- `aetim/web_app.py`：新增 `startup_tasks()` 函數和啟動時自動執行邏輯
- `aetim/scheduler.py`：修改啟動時自動執行邏輯

---

#### 問題 7：時區設定不一致
**發現時間**：2025年11月6日  
**問題描述**：
- 處理狀態與報告的每個區域上的時間，都不是 Docker 預設的時區（Asia/Taipei）
- 生成報告所產生的檔案，檔名的時間也不對

**解決方案**：
- 在 `Dockerfile` 中安裝 `tzdata` 套件並設定時區為 `Asia/Taipei`
- 在 `docker-compose.yml` 中為兩個服務新增 `TZ=Asia/Taipei` 環境變數
- 在 `web_app.py`、`reporting_engine.py`、`notification_handler.py` 中新增 `TAIPEI_TZ` 和 `get_taipei_time()` 函數
- 將所有 `datetime.now()` 替換為 `get_taipei_time()`
- 在前端 JavaScript 中，所有 `toLocaleString()` 呼叫都明確指定 `timeZone: 'Asia/Taipei'`

**修改檔案**：
- `aetim/Dockerfile`：新增時區設定
- `aetim/docker-compose.yml`：新增時區環境變數
- `aetim/web_app.py`：新增時區處理函數並替換所有時間戳記
- `aetim/reporting_engine.py`：新增時區處理函數並替換所有時間戳記
- `aetim/notification_handler.py`：新增時區處理函數並替換所有時間戳記
- `aetim/templates/index.html`：更新前端時間顯示邏輯

---

#### 問題 8：Email 通知功能未啟用檢查邏輯錯誤
**發現時間**：2025年11月6日  
**問題描述**：
- UI 顯示「已完成」和「通知發送完成」，但日誌顯示「通知功能未啟用，跳過週報發送」
- `notify_weekly_report` 函數檢查 `notification.enabled`，但 `config.yaml` 中沒有此設定

**解決方案**：
- 修改 `notify_weekly_report` 函數邏輯，優先檢查 `email.enabled`（對應 UI 中的 Email 通知設定）
- 如果 `email.enabled` 為 `True`，即使 `notification.enabled` 為 `False` 也繼續執行
- 在 `web_app.py` 中確保傳遞 config 時設定 `notification.enabled = True`
- 新增詳細的日誌輸出，顯示兩個設定的狀態

**修改檔案**：
- `aetim/notification_handler.py`：修改通知啟用檢查邏輯
- `aetim/web_app.py`：確保設定正確傳遞

---

#### 問題 9：報告檔案路徑顯示不明顯
**發現時間**：2025年11月6日  
**問題描述**：
- 報告生成後，檔案路徑顯示不明顯，不易識別

**解決方案**：
- 將報告檔案路徑顯示在藍色高亮框（`alert alert-info`）中
- 新增 CSS 屬性（`word-wrap`、`word-break`、`white-space`）實現自動折行顯示

**修改檔案**：
- `aetim/templates/index.html`：修改報告檔案路徑顯示樣式

---

## 問題統計

- **總問題數**：9 個
- **已解決問題數**：9 個
- **待解決問題數**：0 個

---

## 問題分類

### 功能問題
- 問題 1：下次執行時間顯示異常
- 問題 2：動態排程設定功能不完整
- 問題 3：通知人員設定功能限制
- 問題 5：處理狀態與報告顯示問題

### 設定問題
- 問題 4：Email 通知未收到
- 問題 8：Email 通知功能未啟用檢查邏輯錯誤

### 系統問題
- 問題 6：Docker 自動啟動問題
- 問題 7：時區設定不一致

### UI/UX 問題
- 問題 9：報告檔案路徑顯示不明顯

---

## 參考文件

- `修改計劃-執行任務及測試報告/修改計劃_Web界面問題修正_20251106.md`
- `修改計劃-執行任務及測試報告/修改計劃_系統啟動與通知功能修正_20251106.md`
- `修改計劃-執行任務及測試報告/修改計劃_時區與通知修正_20251106.md`

---

**文件維護者**：開發團隊  
**最後審查日期**：2025年11月6日

