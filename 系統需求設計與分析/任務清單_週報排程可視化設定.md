### 任務清單：週報排程可視化設定（依變更計劃執行）

- 版本：v1.0
- 關聯文件：`變更計劃_週報排程可視化設定.md`
- 擁有者：開發/測試/維運

---

#### A. 設定檔與相容處理
- [ ] A1. 調整 `aetim/config.yaml`：加入 `reporting.weekly_report.schedule_struct`
- [ ] A2. 實作「舊欄位相容」解析（`schedule` → `schedule_struct`）但不強制回寫
- [ ] A3. 設定驗證：`day_of_week`、`hour`、`minute`、`timezone`（預設 `Asia/Taipei`）

#### B. 後端 API
- [ ] B1. `GET /api/config` 回傳 `schedule_struct`（若缺失則即時解析自 `schedule`）
- [ ] B2. `POST /api/config` 驗證輸入（非法回 400，訊息清晰）
- [ ] B3. `POST /api/config` 寫回 `config.yaml` 後觸發重排程（見 E）

#### C. Web 介面（`templates/index.html`）
- [ ] C1. 新增「週報排程」設定區塊：星期（mon..sun）、小時（0-23）、分鐘（0-59）
- [ ] C2. 初始化載入：由 `GET /api/config` 取得現值帶入
- [ ] C3. 儲存：呼叫 `POST /api/config`，顯示成功/失敗訊息
- [ ] C4. 錯誤處理：顯示後端回傳的欄位錯誤

#### D. 排程器（`aetim/scheduler.py`）
- [ ] D1. 啟動時依 `schedule_struct` 建立 `CronTrigger`
- [ ] D2. 若缺失或非法 → 預設 `mon 08:00`
- [ ] D3. 實作 `reschedule_weekly_report(scheduler)`：移除舊 job、讀新設定、重建 job、輸出日誌

#### E. 即時重排程（無需重啟）
- [ ] E1. 新增訊號處理：監聽 `SIGUSR2` 以觸發 `reschedule_weekly_report`
- [ ] E2. Web 端在 `POST /api/config` 成功後向 `scheduler.py` 所在 PID 發送 `SIGUSR2`
- [ ] E3. 替代方案（如訊號不可用）：建立「reload 旗標檔」＋排程器輪詢觸發

#### F. 測試
- [ ] F1. API 驗證：合法與非法資料（星期/時/分）單元測試
- [ ] F2. 重排程流程：修改時間後，觀察日誌印出新 day/hour/min
- [ ] F3. 實際觸發：設定為近期時間點（如 +2 分鐘），確認觸發一次
- [ ] F4. 停用 weekly_report.enabled：不建立 weekly job
- [ ] F5. 相容性：僅有舊 `schedule` 時可正常運行並在 UI 顯示正確

#### G. 文件與部署
- [ ] G1. 更新 `aetim/README.md`：新增「在 Web 上變更週報排程」章節
- [ ] G2. 維運手冊：加入訊號重載說明與疑難排解
- [ ] G3. 版本記錄：`README.md` 版本歷史新增此功能

---

#### 里程碑與驗收
- 里程碑 M1：後端 API 與排程器重排程完成（A, B, D, E）
- 里程碑 M2：Web 介面完成（C）
- 里程碑 M3：測試與文件完成（F, G）

驗收標準（抽核）：
1) 將排程改為「週三 09:30」後，無需重啟，排程器日誌顯示已重排程為 wed 09:30  
2) 不合法輸入回 400 並在 UI 顯示錯誤  
3) 僅存在舊 `schedule` 也能正確顯示與運行  
4) 關閉 weekly_report.enabled 時不再建立 weekly job


