# AETIM 正式環境安裝、部署及移轉手冊

**文件版本**：v1.0  
**最後更新**：2025年11月6日  
**專案名稱**：AI 驅動之自動化威脅情資管理系統 (AETIM)  
**適用環境**：Ubuntu 24.04 LTS + Docker

---

## 目錄

1. [前置需求](#前置需求)
2. [系統安裝](#系統安裝)
3. [系統部署](#系統部署)
4. [系統移轉](#系統移轉)
5. [服務管理](#服務管理)
6. [疑難排解](#疑難排解)
7. [附錄](#附錄)

---

## 前置需求

### 1.1 作業系統需求

- **作業系統**：Ubuntu 24.04 LTS（或更新版本）
- **架構**：x86_64（AMD64）
- **記憶體**：建議至少 2GB RAM
- **硬碟空間**：建議至少 10GB 可用空間
- **網路連線**：需要網際網路連線以從情資來源抓取資料

### 1.2 軟體需求

- **Docker**：版本 20.10 或更新
- **Docker Compose**：版本 2.0 或更新
- **Git**：用於版本控制（選用）

### 1.3 網路需求

- **對外連線**：需要能夠存取以下情資來源：
  - CISA KEV API：`https://www.cisa.gov/sites/default/files/feeds/known_exploited_vulnerabilities.json`
  - NVD API：`https://services.nvd.nist.gov/rest/json/cves/2.0`
  - VMware VMSA RSS：`https://www.vmware.com/security/advisories.xml`
  - MSRC API：`https://api.msrc.microsoft.com/cvrf/v2.0/updates`
  - MSRC RSS：`https://msrc.microsoft.com/update-guide/rss`
  - TWCERT RSS：`https://www.twcert.org.tw/tw/rss-1-1.xml`
  - TWCERT/CC RSS：`https://www.twcert.org.tw/tw/rss-1-2.xml`

### 1.4 API 金鑰需求（選填但建議）

- **NVD API 金鑰**：可至 [NVD API 申請頁面](https://nvd.nist.gov/developers/request-an-api-key) 申請，可提高 API 呼叫速率限制
- **OpenAI API 金鑰**：用於 AI 摘要功能（選填）

---

## 系統安裝

### 2.1 安裝 Docker

#### 步驟 1：更新系統套件

```bash
sudo apt-get update
sudo apt-get upgrade -y
```

#### 步驟 2：安裝必要的套件

```bash
sudo apt-get install -y \
    ca-certificates \
    curl \
    gnupg \
    lsb-release
```

#### 步驟 3：新增 Docker 官方 GPG 金鑰

```bash
sudo install -m 0755 -d /etc/apt/keyrings
curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo gpg --dearmor -o /etc/apt/keyrings/docker.gpg
sudo chmod a+r /etc/apt/keyrings/docker.gpg
```

#### 步驟 4：設定 Docker 儲存庫

```bash
echo \
  "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.gpg] https://download.docker.com/linux/ubuntu \
  $(lsb_release -cs) stable" | sudo tee /etc/apt/sources.list.d/docker.list > /dev/null
```

#### 步驟 5：安裝 Docker Engine

```bash
sudo apt-get update
sudo apt-get install -y docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin
```

#### 步驟 6：驗證 Docker 安裝

```bash
sudo docker --version
sudo docker compose version
```

#### 步驟 7：設定 Docker 開機自動啟動

```bash
sudo systemctl enable docker
sudo systemctl start docker
```

#### 步驟 8：將使用者加入 docker 群組（選用，避免每次使用 sudo）

```bash
sudo usermod -aG docker $USER
```

**注意**：執行此命令後，需要重新登入或執行 `newgrp docker` 才能生效。

### 2.2 安裝 Git（選用）

```bash
sudo apt-get install -y git
```

---

## 系統部署

### 3.1 取得專案檔案

#### 方式一：使用 Git（推薦）

```bash
# 建立專案目錄
sudo mkdir -p /opt/aetim
sudo chown $USER:$USER /opt/aetim
cd /opt/aetim

# 複製專案（請替換為實際的 Git 儲存庫 URL）
git clone <repository-url> .
```

#### 方式二：直接上傳檔案

```bash
# 建立專案目錄
sudo mkdir -p /opt/aetim
sudo chown $USER:$USER /opt/aetim
cd /opt/aetim

# 使用 scp 或其他方式上傳專案檔案到此目錄
```

### 3.2 準備環境變數檔案

#### 步驟 1：建立 `.env` 檔案

```bash
cd /opt/aetim/aetim
cat > .env << EOF
# NVD API 金鑰（選填但建議）
NVD_API_KEY=your_nvd_api_key_here

# OpenAI API 金鑰（選填）
OPENAI_API_KEY=your_openai_api_key_here
EOF
```

#### 步驟 2：編輯 `.env` 檔案

使用文字編輯器（如 `nano` 或 `vi`）編輯 `.env` 檔案，填入實際的 API 金鑰：

```bash
nano .env
```

**注意**：
- 如果沒有 NVD API 金鑰，可以留空，系統會以較低速率執行
- 如果沒有 OpenAI API 金鑰，可以留空，AI 摘要功能將無法使用

### 3.3 確認資產清單檔案

#### 步驟 1：確認 CSV 檔案存在

```bash
ls -lh /opt/aetim/aetim/資產清單\ -\ Sheet1.csv
```

#### 步驟 2：確認檔案名稱與設定一致

檢查 `config.yaml` 中的設定：

```bash
grep "csv_file" /opt/aetim/aetim/config.yaml
```

**重要**：CSV 檔案名稱必須與 `config.yaml` 中的設定一致。

### 3.4 初始化資料庫

#### 步驟 1：進入專案目錄

```bash
cd /opt/aetim/aetim
```

#### 步驟 2：執行資料庫初始化

```bash
docker compose run --rm aetim python setup_database.py
```

**成功訊息範例**：
```
成功建立/初始化資料庫結構。
成功從 資產清單 - Sheet1.csv 匯入 X 筆資產至 T_Assets 資料表。
```

### 3.5 調整系統設定（選填）

#### 步驟 1：編輯 `config.yaml`

```bash
nano /opt/aetim/aetim/config.yaml
```

#### 步驟 2：調整排程設定

```yaml
scheduler:
  interval:
    hours: 4        # 每 N 小時執行一次（預設：4）
    minutes: null   # 每 N 分鐘執行一次（設為 null 表示不使用）
```

**設定範例**：
- 每 30 分鐘執行：`interval: { minutes: 30, hours: null }`
- 每 6 小時執行：`interval: { hours: 6, minutes: null }`

#### 步驟 3：調整通知設定

```yaml
notification:
  email:
    enabled: true
    smtp_server: "smtp.gmail.com"
    smtp_port: 587
    smtp_username: "${EMAIL_USERNAME}"
    smtp_password: "${EMAIL_PASSWORD}"
    from_address: "${EMAIL_FROM}"
    to_address: "${EMAIL_TO}"
    use_tls: true
    ciso_email: "ciso@yourcompany.com"
    it_email: "it@yourcompany.com"
```

**注意**：Email 設定也可以在 Web 界面中進行，無需手動編輯 `config.yaml`。

#### 步驟 4：調整「週報排程」設定（新功能）

- 方式一（推薦）：在 Web 介面「週報排程設定」直接選擇星期/小時/分鐘並儲存  
  容器環境中，為立即生效可發送 USR2 訊號給排程器容器（見下方）。

- 方式二（編輯檔案）：在 `config.yaml` 設置結構化排程欄位：
```yaml
reporting:
  weekly_report:
    enabled: true
    schedule_struct:
      day_of_week: mon     # mon,tue,wed,thu,fri,sat,sun
      hour: 8              # 0-23
      minute: 0            # 0-59
      timezone: Asia/Taipei
    # 舊欄位（相容）：schedule: monday 08:00
```

變更後讓排程器立即重載（不重啟容器）：
```bash
cd /opt/aetim/aetim
docker compose kill --signal=USR2 aetim
```
說明：compose 服務 `aetim` 即為排程器容器，送 USR2 會讓其重新讀取 `config.yaml` 並重排程。

### 3.6 啟動服務

#### 步驟 1：建置 Docker 映像檔

```bash
cd /opt/aetim/aetim
docker compose build
```

#### 步驟 2：啟動服務

```bash
docker compose up -d
```

#### 步驟 3：驗證服務狀態

```bash
docker compose ps
```

**預期輸出**：
```
NAME                 IMAGE              STATUS
aetim_service        aetim-app:latest   Up
aetim_web_service     aetim-app:latest   Up
```

#### 步驟 4：查看服務日誌

```bash
# 查看所有服務日誌
docker compose logs -f

# 查看特定服務日誌
docker compose logs -f aetim
docker compose logs -f aetim-web
```

### 3.7 驗證安裝

#### 步驟 1：檢查資料庫是否正確初始化

```bash
docker compose exec aetim sqlite3 /app/aetim.db "SELECT COUNT(*) FROM T_Assets;"
```

#### 步驟 2：檢查 Web 界面是否可訪問

在瀏覽器中訪問：
```
http://<server-ip>:5001
```

**注意**：如果伺服器有防火牆，請確保端口 5001 已開放。

#### 步驟 3：檢查收集器執行狀態

```bash
docker compose logs aetim | grep -i "collector\|完成\|錯誤"
```

#### 步驟 4（新）：檢視「週報排程監視」
- 網頁下半部「週報排程監視」卡片會顯示最近週報事件（時間、階段、狀態、收件者遮罩、訊息）
- 可點「測試寄送」快速驗證 SMTP 與週報通知
- 後端事件儲存路徑（容器內）：`/app/logs/weekly_jobs/YYYYMM/YYYYMMDD.jsonl`

---

## 系統移轉

### 4.1 從舊環境移轉資料

#### 步驟 1：備份舊環境資料

在舊環境中執行：

```bash
# 備份資料庫
docker compose exec aetim sqlite3 /app/aetim.db ".backup /app/aetim_backup.db"

# 備份報告目錄（如果存在）
docker compose exec aetim tar -czf /app/reports_backup.tar.gz /app/reports/

# 複製備份檔案到新環境
# 使用 scp 或其他方式將備份檔案傳輸到新環境
```

#### 步驟 2：在新環境中還原資料

在新環境中執行：

```bash
cd /opt/aetim/aetim

# 停止服務
docker compose down

# 還原資料庫
docker compose run --rm aetim sqlite3 /app/aetim.db ".restore /path/to/aetim_backup.db"

# 還原報告目錄（如果存在）
docker compose run --rm aetim tar -xzf /path/to/reports_backup.tar.gz -C /

# 重新啟動服務
docker compose up -d
```

### 4.2 移轉設定檔

#### 步驟 1：備份舊環境設定檔

在舊環境中執行：

```bash
# 備份 config.yaml
cp /opt/aetim/aetim/config.yaml /opt/aetim/aetim/config.yaml.backup

# 備份 .env
cp /opt/aetim/aetim/.env /opt/aetim/aetim/.env.backup
```

#### 步驟 2：在新環境中還原設定檔

在新環境中執行：

```bash
# 還原 config.yaml
cp /path/to/config.yaml /opt/aetim/aetim/config.yaml

# 還原 .env
cp /path/to/.env /opt/aetim/aetim/.env

# 重新啟動服務以套用新設定
docker compose restart
```

### 4.3 驗證移轉結果

#### 步驟 1：檢查資料庫記錄數

```bash
docker compose exec aetim sqlite3 /app/aetim.db "
SELECT 
    (SELECT COUNT(*) FROM T_Assets) as assets,
    (SELECT COUNT(*) FROM T_Raw_Intel) as intel,
    (SELECT COUNT(*) FROM T_Validated_Threats) as threats;
"
```

#### 步驟 2：檢查報告檔案

```bash
docker compose exec aetim find /app/reports -type f | wc -l
```

#### 步驟 3：測試系統功能

1. 訪問 Web 界面：`http://<server-ip>:5001`
2. 測試手動觸發收集任務
3. 測試報告生成功能
4. 測試通知發送功能

---

## 服務管理

### 5.1 服務啟動與停止

#### 啟動服務

```bash
cd /opt/aetim/aetim
docker compose up -d
```

#### 停止服務

```bash
docker compose stop
```

#### 重新啟動服務

```bash
docker compose restart
```

#### 完全停止並移除容器

```bash
docker compose down
```

**注意**：此命令不會刪除資料庫和報告檔案（因為它們儲存在 volume 中）。

### 5.2 查看服務日誌

#### 查看所有服務日誌

```bash
docker compose logs -f
```

#### 查看最近 100 行日誌

```bash
docker compose logs --tail=100
```

#### 查看特定服務日誌

```bash
docker compose logs -f aetim
docker compose logs -f aetim-web
```

### 5.3 服務自動啟動設定

#### Docker 服務自動啟動

Docker 服務預設會在系統啟動時自動啟動（已在安裝步驟中設定）。

#### AETIM 容器自動啟動

AETIM 容器已設定 `restart: unless-stopped`，會在 Docker 服務啟動時自動啟動。

**驗證自動啟動設定**：

```bash
# 檢查 Docker 服務狀態
sudo systemctl status docker

# 檢查 AETIM 容器狀態
docker compose ps
```

### 5.4 更新系統

#### 更新程式碼

```bash
cd /opt/aetim/aetim

# 如果使用 Git
git pull

# 重新建置並啟動
docker compose up -d --build
```

#### 更新依賴套件

```bash
cd /opt/aetim/aetim

# 編輯 requirements.txt
nano requirements.txt

# 重新建置
docker compose build --no-cache
docker compose up -d
```

### 5.5 備份與還原

#### 備份資料庫

```bash
cd /opt/aetim/aetim
docker compose exec aetim sqlite3 /app/aetim.db ".backup /app/aetim_backup_$(date +%Y%m%d_%H%M%S).db"
```

#### 備份報告目錄

```bash
cd /opt/aetim/aetim
docker compose exec aetim tar -czf /app/reports_backup_$(date +%Y%m%d_%H%M%S).tar.gz /app/reports/
```

#### 還原資料庫

```bash
cd /opt/aetim/aetim
docker compose stop
docker compose run --rm aetim sqlite3 /app/aetim.db ".restore /app/aetim_backup_YYYYMMDD_HHMMSS.db"
docker compose up -d
```

---

## 疑難排解

### 6.1 Docker 相關問題

#### 問題：無法啟動 Docker 服務

**錯誤訊息**：`Cannot connect to Docker daemon`

**解決方法**：
```bash
# 檢查 Docker 服務狀態
sudo systemctl status docker

# 啟動 Docker 服務
sudo systemctl start docker

# 設定開機自動啟動
sudo systemctl enable docker
```

#### 問題：Docker Compose 命令不存在

**錯誤訊息**：`docker-compose: command not found`

**解決方法**：
```bash
# Ubuntu 24.04 使用 Docker Compose Plugin
# 使用以下命令：
docker compose up -d

# 或安裝舊版 docker-compose
sudo apt-get install -y docker-compose
```

### 6.2 資料庫相關問題

#### 問題：找不到資產清單 CSV 檔案

**錯誤訊息**：`錯誤：找不到資產清單檔案`

**解決方法**：
1. 確認 CSV 檔案名稱與 `config.yaml` 中的設定一致
2. 確認檔案位於 `/opt/aetim/aetim/` 目錄下
3. 檢查檔案權限：`ls -lh /opt/aetim/aetim/資產清單\ -\ Sheet1.csv`

#### 問題：資料庫初始化失敗

**錯誤訊息**：`錯誤：無法建立資料庫`

**解決方法**：
```bash
# 檢查目錄權限
ls -ld /opt/aetim/aetim

# 確認有寫入權限
sudo chown -R $USER:$USER /opt/aetim/aetim

# 重新執行初始化
docker compose run --rm aetim python setup_database.py
```

### 6.3 網路相關問題

#### 問題：無法連線到情資來源

**錯誤訊息**：`錯誤：抓取 CISA KEV 失敗`

**解決方法**：
1. 檢查網路連線：`ping www.cisa.gov`
2. 檢查防火牆設定：`sudo ufw status`
3. 檢查代理設定（如果使用代理）

#### 問題：NVD API 速率限制

**錯誤訊息**：`錯誤 (Request)：抓取 NVD API 失敗：429 Too Many Requests`

**解決方法**：
1. 申請 NVD API 金鑰並填入 `.env` 檔案
2. 系統會自動根據是否有 API 金鑰調整請求間隔（有金鑰：6 秒，無金鑰：10 秒）

### 6.4 Web 界面相關問題

#### 問題：無法訪問 Web 界面

**錯誤訊息**：`無法連線到此網站`

**解決方法**：
1. 確認服務已啟動：`docker compose ps`
2. 檢查端口是否被佔用：`sudo netstat -tlnp | grep 5001`
3. 檢查防火牆設定：`sudo ufw allow 5001/tcp`
4. 查看服務日誌：`docker compose logs aetim-web`

#### 問題：Web 界面顯示錯誤

**錯誤訊息**：`500 Internal Server Error`

**解決方法**：
1. 查看後端日誌：`docker compose logs aetim-web --tail=50`
2. 檢查資料庫連線：`docker compose exec aetim sqlite3 /app/aetim.db "SELECT 1;"`
3. 檢查設定檔格式：`docker compose exec aetim-web python -c "import yaml; yaml.safe_load(open('config.yaml'))"`

### 6.5 通知相關問題

#### 問題：Email 通知未收到

**錯誤訊息**：`通知功能未啟用`

**解決方法**：
1. 檢查 Email 設定：在 Web 界面中檢查「通知人員設定」和「SMTP 設定」
2. 測試 SMTP 連線：在 Web 界面中點擊「測試 SMTP」按鈕
3. 查看通知日誌：`docker compose logs aetim-web | grep -i "通知"`
4. 確認 `email.enabled` 為 `true`：`grep "enabled" /opt/aetim/aetim/config.yaml`

### 6.6 時區相關問題

#### 問題：時間顯示不正確

**錯誤訊息**：時間顯示與系統時間不一致

**解決方法**：
1. 確認 Docker 容器時區設定：`docker compose exec aetim date`
2. 確認環境變數：`docker compose exec aetim env | grep TZ`
3. 重新啟動服務：`docker compose restart`

---

## 附錄

### A.1 目錄結構

```
/opt/aetim/
└── aetim/
    ├── collectors.py
    ├── correlation_engine.py
    ├── reporting_engine.py
    ├── notification_handler.py
    ├── scheduler.py
    ├── trigger_collectors.py
    ├── setup_database.py
    ├── utils.py
    ├── web_app.py
    ├── config.yaml
    ├── requirements.txt
    ├── Dockerfile
    ├── docker-compose.yml
    ├── .env
    ├── aetim.db
    ├── reports/
    │   └── yyyy/
    │       └── yyyymm/
    ├── templates/
    │   └── index.html
    └── logs/
        └── weekly_jobs/
            └── YYYYMM/
                └── YYYYMMDD.jsonl
```

### A.2 重要檔案說明

- **`config.yaml`**：系統設定檔，包含排程、通知、情資來源等設定
- **`.env`**：環境變數檔案，包含 API 金鑰等敏感資訊
- **`aetim.db`**：SQLite 資料庫檔案，包含資產、情資、威脅等資料
- **`reports/`**：報告輸出目錄，按年月自動分類
- **`logs/weekly_jobs/`**：週報排程事件（JSONL），可用於查詢週報觸發與通知結果

### A.3 常用命令參考

```