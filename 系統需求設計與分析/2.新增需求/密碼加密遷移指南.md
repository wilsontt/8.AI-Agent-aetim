# AETIM SMTP 密碼加密遷移指南

## 文件資訊

**專案名稱**：AI 驅動之自動化威脅情資管理系統 (AETIM)  
**文件版本**：v1.0  
**建立日期**：2025年11月7日  
**目的**：說明如何將 config.yaml 中的明碼 SMTP 密碼遷移到加密方式

---

## 目錄

1. [遷移前準備](#遷移前準備)
2. [方式一：使用環境變數（推薦）](#方式一使用環境變數推薦)
3. [方式二：使用加密字串](#方式二使用加密字串)
4. [驗證遷移](#驗證遷移)
5. [常見問題](#常見問題)

---

## 遷移前準備

### 1. 備份現有設定檔

```bash
# 備份 config.yaml
cp config.yaml config.yaml.backup
```

### 2. 確認當前密碼

確認您知道當前的 SMTP 密碼，以便進行遷移。

### 3. 選擇遷移方式

- **方式一：環境變數**（推薦，最安全）
  - 密碼儲存在 `.env` 檔案或系統環境變數中
  - 符合 12-Factor App 原則
  - 最符合 ISO 27001:2022 規範

- **方式二：加密字串**
  - 密碼加密後儲存在 `config.yaml` 中
  - 需要管理加密密鑰
  - 適合無法使用環境變數的環境

---

## 方式一：使用環境變數（推薦）

### 步驟 1：設定環境變數

**方法 A：使用 .env 檔案（Docker Compose）**

編輯 `.env` 檔案，新增以下內容：

```bash
# SMTP 密碼（環境變數）
EMAIL_PASSWORD=your_actual_password_here
```

**方法 B：系統環境變數（Linux/macOS）**

```bash
# 臨時設定（當前終端）
export EMAIL_PASSWORD=your_actual_password_here

# 永久設定（加入 ~/.bashrc 或 ~/.zshrc）
echo 'export EMAIL_PASSWORD=your_actual_password_here' >> ~/.bashrc
source ~/.bashrc
```

**方法 C：Docker Compose 環境變數**

在 `docker-compose.yml` 中設定：

```yaml
services:
  aetim-web:
    environment:
      - EMAIL_PASSWORD=your_actual_password_here
```

### 步驟 2：更新 config.yaml

編輯 `config.yaml`，將 `smtp_password` 改為環境變數引用：

```yaml
notification:
  email:
    smtp_password: ${EMAIL_PASSWORD}
```

### 步驟 3：重新啟動服務

```bash
# 重新啟動服務
docker-compose restart

# 或重新載入環境變數
docker-compose down
docker-compose up -d
```

### 步驟 4：驗證

1. 檢查服務日誌，確認沒有密碼相關警告
2. 透過 Web 界面測試 SMTP 連線
3. 發送測試通知

---

## 方式二：使用加密字串

### 步驟 1：產生加密密鑰

**方法 A：使用環境變數（推薦）**

```bash
# 產生 32 bytes 的 base64 編碼密鑰
export AETIM_ENCRYPTION_KEY=$(openssl rand -base64 32)

# 驗證密鑰
echo $AETIM_ENCRYPTION_KEY
```

**方法 B：使用密鑰檔案**

```bash
# 產生密鑰檔案
openssl rand -base64 32 > .aetim_key

# 設定檔案權限（僅擁有者可讀寫）
chmod 600 .aetim_key

# 驗證密鑰檔案
cat .aetim_key
```

**方法 C：使用加密工具產生**

```bash
python encrypt_password.py --generate-key
```

### 步驟 2：加密密碼

```bash
# 使用加密工具加密密碼
python encrypt_password.py "your_actual_password_here"

# 輸出範例：
# ============================================================
# 加密成功
# ============================================================
# 加密字串：
# ENCRYPTED:xxxxx:yyyyy:zzzzz
# ============================================================
```

### 步驟 3：更新 config.yaml

編輯 `config.yaml`，將 `smtp_password` 改為加密字串：

```yaml
notification:
  email:
    smtp_password: ENCRYPTED:xxxxx:yyyyy:zzzzz
```

### 步驟 4：確保密鑰可用

**如果使用環境變數：**

```bash
# 確認環境變數已設定
echo $AETIM_ENCRYPTION_KEY

# 如果未設定，重新設定
export AETIM_ENCRYPTION_KEY=your_base64_encoded_key_here
```

**如果使用密鑰檔案：**

```bash
# 確認密鑰檔案存在且權限正確
ls -l .aetim_key
# 應該顯示：-rw------- (600)
```

### 步驟 5：重新啟動服務

```bash
# 重新啟動服務
docker-compose restart
```

### 步驟 6：驗證

1. 檢查服務日誌，確認沒有解密錯誤
2. 透過 Web 界面測試 SMTP 連線
3. 發送測試通知

---

## 驗證遷移

### 1. 檢查日誌

```bash
# 查看服務日誌
docker-compose logs aetim-web | grep -i password

# 應該看到：
# - 沒有「警告：config.yaml 中使用明碼 SMTP 密碼」訊息（如果使用環境變數或加密字串）
# - 沒有解密錯誤訊息
```

### 2. 測試 SMTP 連線

1. 訪問 Web 界面：`http://localhost:5001`
2. 進入「SMTP 設定」區塊
3. 點擊「測試 SMTP」按鈕
4. 確認測試成功

### 3. 測試 Email 發送

1. 在「通知處理」區塊選擇通知類型
2. 選擇收件者
3. 點擊「發送通知」
4. 確認 Email 已成功發送

---

## 常見問題

### Q1：遷移後 Email 無法發送？

**可能原因：**
1. 環境變數未正確設定
2. 加密密鑰未設定或不正確
3. 加密字串格式錯誤

**解決方案：**
1. 檢查環境變數：`echo $EMAIL_PASSWORD` 或 `echo $AETIM_ENCRYPTION_KEY`
2. 檢查服務日誌：`docker-compose logs aetim-web`
3. 驗證加密字串格式：應為 `ENCRYPTED:xxxxx:yyyyy:zzzzz`
4. 測試解密：`python encrypt_password.py --decrypt ENCRYPTED:xxxxx:yyyyy:zzzzz`

### Q2：如何從加密字串遷移到環境變數？

1. 解密密碼（使用加密工具）
2. 將密碼設定到環境變數
3. 更新 `config.yaml` 為 `${EMAIL_PASSWORD}`
4. 重新啟動服務

### Q3：遺失加密密鑰怎麼辦？

**如果使用環境變數：**
- 重新設定環境變數（但無法解密已加密的密碼）
- 需要重新加密密碼

**如果使用密鑰檔案：**
- 如果沒有備份，無法解密已加密的密碼
- 需要重新產生密鑰並重新加密密碼

**建議：**
- 妥善保管加密密鑰
- 定期備份密鑰檔案
- 使用環境變數方式（更安全）

### Q4：如何在多個環境使用不同的密碼？

**開發環境：**
```yaml
# config.yaml
smtp_password: ${EMAIL_PASSWORD_DEV}
```

```bash
# .env.dev
EMAIL_PASSWORD_DEV=dev_password
```

**生產環境：**
```yaml
# config.yaml
smtp_password: ${EMAIL_PASSWORD_PROD}
```

```bash
# .env.prod
EMAIL_PASSWORD_PROD=prod_password
```

### Q5：Web 界面顯示「密碼已設定（加密或環境變數）」但無法更新？

這是正常的。如果密碼已設定為環境變數或加密字串，Web 界面不會顯示實際值。

**更新密碼的方法：**
1. **環境變數方式**：更新環境變數值
2. **加密字串方式**：重新加密新密碼，更新 `config.yaml`

---

## 安全建議

1. ✅ **優先使用環境變數**：最安全，符合最佳實踐
2. ✅ **妥善保管加密密鑰**：如果使用加密字串方式
3. ✅ **定期輪換密碼**：建議每 90 天更換一次
4. ✅ **限制密鑰檔案權限**：`chmod 600 .aetim_key`
5. ✅ **不要將密碼提交到版本控制**：確保 `.env` 和 `.aetim_key` 在 `.gitignore` 中
6. ✅ **使用不同的密碼**：開發、測試、生產環境使用不同密碼

---

## 相關文件

- [SMTP 密碼加密實作計劃](../系統需求設計與分析/SMTP密碼加密實作計劃.md)
- [正式環境安裝部署移轉手冊](../系統需求設計與分析/正式環境安裝部署移轉手冊.md)
- [README.md](README.md)

---

**文件版本**：v1.0  
**建立日期**：2025年11月7日  
**維護者**：開發團隊

