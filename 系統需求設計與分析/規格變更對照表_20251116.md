# 規格變更對照表

**日期**：2025-11-16  
**目的**：檢視這2天的調整，找出與原始規格相關的變更（排除bug修復）

---

## 變更項目清單

### 1. 週報排程可視化設定 ✅ **符合規格（新功能）**

**變更內容**：
- 新增 Web 界面設定週報排程時間（星期、小時、分鐘）
- 支援動態重排程（SIGUSR2 訊號觸發）
- 新增 `schedule_struct` 結構化設定欄位

**規格對照**：
- **原始規格**（`0.2.規格_spec.md` 第327行）：「週報生成：排程：每週一上午 8:00」
- **變更後**：排程時間可透過 Web 界面調整，不再固定
- **狀態**：✅ **符合變更計劃**（`變更計劃_週報排程可視化設定.md`）

**影響**：
- 增強功能，不影響原有規格邏輯
- 向後相容：仍支援舊的 `schedule` 字串格式

---

### 2. 週報排程監視功能 ✅ **符合規格（新功能）**

**變更內容**：
- 新增週報排程監視視窗，顯示最近執行記錄
- 記錄所有執行狀態（成功、失敗、跳過）
- 提供測試寄送功能

**規格對照**：
- **原始規格**：未明確規定監視功能
- **狀態**：✅ **功能增強**，不違反規格

**影響**：
- 提升可觀測性，有助於故障排除

---

### 3. 通知設定結構重構 ⚠️ **部分偏離規格**

**變更內容**：
- 將「通知處理」改為「通知設定」
- 新增 `notification.types` 結構，支援3種類型：
  - `critical`：嚴重威脅通知
  - `high_daily`：高風險每日摘要
  - `weekly_report`：週報通知
- 新增 `notification.recipients` 結構，支援2類收件者：
  - `ciso`：CISO 收件者
  - `it`：IT 收件者
- 每種類型可獨立設定啟用狀態和收件者群組

**規格對照**：
- **原始規格**（`0.2.規格_spec.md` 第527-545行）：
  ```yaml
  notification:
    email:
      ciso_email: "ciso@yourcompany.com"
      it_email: "it@yourcompany.com"
  ```
- **變更後**：
  ```yaml
  notification:
    recipients:
      ciso: "ciso@yourcompany.com"
      it: "it@yourcompany.com"
    types:
      weekly_report:
        enabled: true
        recipients: [ciso, it]
  ```
- **狀態**：⚠️ **結構變更**，但功能邏輯保持一致

**影響**：
- 更靈活的設定方式，但與原始規格結構不同
- 向後相容：仍支援 `ciso_email` 和 `it_email`

---

### 4. 週報報告生成邏輯調整 ⚠️ **偏離規格**

**變更內容**：
- 週報排程時，根據收件者類型決定生成哪些報告：
  - 如果收件者包含 `ciso`：生成 CISO 週報
  - 如果收件者包含 `it`：生成 IT 工單彙總報告
- 支援同時生成兩種報告並分別發送

**規格對照**：
- **原始規格**（`階段三 3.產生分析報告_Reporting Engine.md` 第61-68行）：
  - **工作流 3：管理層週報**
    - 觸發：排程（每週一上午 8:00）
    - 執行：生成報告 A (CISO 週報)
    - 通知：發送 Email 報告給「您」（資安官）
  
- **原始規格**（`階段三 3.產生分析報告_Reporting Engine.md` 第21-33行）：
  - **報告模板 B：IT 維運工單**
    - 觸發：**即時觸發**（當風險分數 > 7.0 時立即生成）
    - 受眾：IT 工程師（根據 T_Assets.負責人 欄位）

- **變更後**：
  - 週報排程時也會生成 IT 工單（彙總格式）
  - 可以同時發送給 CISO 和 IT

- **狀態**：⚠️ **偏離規格**
  - 規格中 IT 工單是「即時觸發」，但現在也在週報排程中生成
  - 規格中週報是「發送給您（資安官）」，但現在可以發送給 IT

**影響**：
- 功能增強，但與原始規格描述不同
- 需要確認是否符合實際需求

---

## 建議檢視項目

### 1. 週報報告生成邏輯 ⚠️ **需要確認**

**問題**：
- 規格中 IT 工單是「即時觸發」，但現在也在週報排程中生成 IT 工單彙總
- 這是否為預期行為？

**選項**：
- **選項 A**：維持現狀（週報排程可同時生成 CISO 週報和 IT 工單彙總）
- **選項 B**：回歸規格（週報排程只生成 CISO 週報，IT 工單保持即時觸發）
- **選項 C**：更新規格文件，明確說明週報排程可同時生成兩種報告

### 2. 通知設定結構 ⚠️ **需要確認**

**問題**：
- 新的 `notification.types` 和 `notification.recipients` 結構與原始規格不同
- 是否需要更新規格文件以反映新結構？

**建議**：
- 更新 `0.2.規格_spec.md` 中的設定檔規格章節
- 說明新結構的優勢和向後相容性

### 3. 週報收件者設定 ⚠️ **需要確認**

**問題**：
- 規格中週報是「發送給您（資安官）」
- 現在可以設定發送給 CISO 和 IT
- 這是否為預期行為？

**建議**：
- 確認「資安官」是否等同於「CISO」
- 確認 IT 是否應該收到週報（還是只收到 IT 工單）

---

## 總結

### ✅ 符合規格的變更
1. 週報排程可視化設定（新功能，有變更計劃）
2. 週報排程監視功能（新功能，功能增強）

### ⚠️ 需要確認的變更
1. **週報報告生成邏輯**：IT 工單在週報排程中生成（規格中是即時觸發）
2. **通知設定結構**：新的結構化設定（與原始規格不同）
3. **週報收件者**：可同時發送給 CISO 和 IT（規格中只提到「您」）

### 📝 建議行動
1. 確認週報排程中生成 IT 工單是否符合需求
2. 更新規格文件以反映新的設定結構
3. 明確說明週報的收件者範圍（CISO、IT、或兩者）

---

**最後更新**：2025-11-16

