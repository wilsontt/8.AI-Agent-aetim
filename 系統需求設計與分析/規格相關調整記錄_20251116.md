# 規格相關調整記錄

**文件版本**：v1.0  
**建立日期**：2025-11-16  
**最後更新**：2025-11-16  
**記錄範圍**：2025-11-15 至 2025-11-16 的規格相關變更

---

## 變更摘要

本記錄追蹤這2天內與系統規格相關的調整，包括新功能、結構變更和邏輯調整。

---

## 變更項目

### 1. 週報排程可視化設定（新功能）

**變更類型**：功能增強  
**變更日期**：2025-11-15  
**相關文件**：
- `變更計劃_週報排程可視化設定.md`
- `任務清單_週報排程可視化設定.md`

**變更內容**：
- 新增 Web 界面設定週報排程時間（星期、小時、分鐘）
- 支援動態重排程（SIGUSR2 訊號觸發，無需重啟服務）
- 新增 `reporting.weekly_report.schedule_struct` 結構化設定欄位

**規格影響**：
- **原始規格**（`0.2.規格_spec.md`）：週報排程固定為「每週一上午 8:00」
- **變更後**：排程時間可透過 Web 界面動態調整
- **狀態**：✅ 符合變更計劃，功能增強

**需要更新的文件**：
- ✅ `0.2.規格_spec.md` - 設定檔規格章節（已更新）
- ✅ `aetim/README.md` - 操作說明（已更新）
- ✅ `正式環境安裝部署移轉手冊.md` - 設定說明（已更新）

---

### 2. 週報排程監視功能（新功能）

**變更類型**：功能增強  
**變更日期**：2025-11-15  
**相關文件**：無（新功能）

**變更內容**：
- 新增週報排程監視視窗（Web 界面）
- 記錄所有執行狀態（成功、失敗、跳過、錯誤）
- 提供測試寄送功能
- 使用 JSONL 格式記錄事件（`logs/weekly_jobs/YYYYMM/YYYYMMDD.jsonl`）

**規格影響**：
- **原始規格**：未明確規定監視功能
- **變更後**：新增可觀測性功能
- **狀態**：✅ 功能增強，不違反規格

**需要更新的文件**：
- ✅ `aetim/README.md` - 新增監視功能說明（已更新）
- ✅ `正式環境安裝部署移轉手冊.md` - 新增驗證步驟（已更新）

---

### 3. 通知設定結構重構

**變更類型**：結構變更  
**變更日期**：2025-11-16  
**相關文件**：無（需求變更）

**變更內容**：
- 將「通知處理」改為「通知設定」（UI 調整）
- 新增 `notification.types` 結構，支援3種類型：
  - `critical`：嚴重威脅通知（風險分數 ≥ threshold）
  - `high_daily`：高風險每日摘要（風險分數 ≥ threshold，每日彙總）
  - `weekly_report`：週報通知
- 新增 `notification.recipients` 結構，統一管理收件者：
  - `ciso`：CISO 收件者 Email
  - `it`：IT 收件者 Email
- 每種類型可獨立設定：
  - `enabled`：是否啟用
  - `recipients`：收件者群組（`[ciso]`, `[it]`, `[ciso, it]`）
  - `threshold`：風險分數閾值（critical/high_daily）

**規格影響**：
- **原始規格**（`0.2.規格_spec.md` 第527-545行）：
  ```yaml
  notification:
    email:
      ciso_email: "ciso@yourcompany.com"
      it_email: "it@yourcompany.com"
  ```
- **變更後**：
  ```yaml
  notification:
    recipients:
      ciso: "ciso@yourcompany.com"
      it: "it@yourcompany.com"
    types:
      critical:
        enabled: true
        recipients: [it, ciso]
        threshold: 9.0
      high_daily:
        enabled: true
        recipients: [it]
        threshold: 7.0
      weekly_report:
        enabled: true
        recipients: [ciso]
  ```
- **狀態**：⚠️ 結構變更，但功能邏輯保持一致

**向後相容性**：
- ✅ 仍支援 `ciso_email` 和 `it_email`（自動映射到 `recipients`）
- ✅ 仍支援 `to_address`（作為預設收件者）

**需要更新的文件**：
- ⚠️ `0.2.規格_spec.md` - 設定檔規格章節（**需要更新**）
- ✅ `aetim/README.md` - 通知設定說明（已更新）

---

### 4. 週報報告生成邏輯調整

**變更類型**：邏輯變更  
**變更日期**：2025-11-16  
**相關文件**：無（需求變更）

**變更內容**：
- 週報排程時，根據收件者類型決定生成哪些報告：
  - 如果收件者包含 `ciso`：生成 CISO 週報（HTML 格式）
  - 如果收件者包含 `it`：生成 IT 工單彙總報告（JSON 格式，包含所有高風險威脅工單）
- 支援同時生成兩種報告並分別發送給對應收件者
- 新增 `notify_it_tickets()` 函數，用於發送 IT 工單報告

**規格影響**：
- **原始規格**（`階段三 3.產生分析報告_Reporting Engine.md` 第61-68行）：
  - **工作流 3：管理層週報**
    - 觸發：排程（每週一上午 8:00）
    - 執行：生成報告 A (CISO 週報)
    - 通知：發送 Email 報告給「您」（資安官）
  
- **原始規格**（`階段三 3.產生分析報告_Reporting Engine.md` 第21-33行）：
  - **報告模板 B：IT 維運工單**
    - 觸發：**即時觸發**（當風險分數 > 7.0 時立即生成）
    - 受眾：IT 工程師（根據 T_Assets.負責人 欄位）

- **變更後**：
  - 週報排程時也會生成 IT 工單彙總（針對過去7天的高風險威脅）
  - 可以同時發送給 CISO 和 IT
  - IT 工單仍保持即時觸發功能（嚴重威脅時）

- **狀態**：⚠️ **邏輯變更**，擴展了原始規格

**說明**：
- IT 工單有兩種觸發方式：
  1. **即時觸發**：當發現嚴重威脅（風險分數 ≥ 9.0）時立即生成並發送
  2. **週報彙總**：每週排程時，彙總過去7天的高風險威脅（風險分數 ≥ 7.0）生成工單報告

**需要更新的文件**：
- ⚠️ `階段三 3.產生分析報告_Reporting Engine.md` - 工作流 3 說明（**需要更新**）
- ⚠️ `0.2.規格_spec.md` - 報告生成規格（**需要更新**）

---

## 需要更新的規格文件清單

### 高優先級（必須更新）

1. **`0.2.規格_spec.md`**
   - [ ] 更新設定檔規格章節（`notification` 結構）
   - [ ] 更新報告生成規格（週報可同時生成 CISO 週報和 IT 工單）
   - [ ] 更新 `notify_weekly_report()` 函數說明

2. **`階段三 3.產生分析報告_Reporting Engine.md`**
   - [ ] 更新「工作流 3：管理層週報」說明
   - [ ] 明確說明 IT 工單的兩種觸發方式（即時 + 週報彙總）
   - [ ] 更新收件者說明（CISO 和 IT）

### 中優先級（建議更新）

3. **`0.1.專案初始化摘要.md`**
   - [ ] 更新通知設定說明
   - [ ] 更新週報排程說明

4. **`0.3.實作計劃_tasks.md`**
   - [ ] 標記已完成的新功能
   - [ ] 記錄規格變更

---

## 變更決策記錄

### 決策 1：週報排程中生成 IT 工單彙總

**決策日期**：2025-11-16  
**決策內容**：週報排程時，如果收件者包含 IT，則同時生成 IT 工單彙總報告

**理由**：
- 提供 IT 團隊每週的高風險威脅彙總
- 與即時觸發的 IT 工單互補（即時處理嚴重威脅，週報提供整體概覽）

**影響**：
- 擴展了原始規格中「IT 工單僅即時觸發」的定義
- 需要更新規格文件以反映此變更

---

### 決策 2：通知設定結構化

**決策日期**：2025-11-16  
**決策內容**：將通知設定改為結構化格式，支援每種類型獨立設定

**理由**：
- 更靈活的設定方式
- 可以精確控制每種通知類型的收件者
- 符合實際運作需求（不同類型通知給不同收件者）

**影響**：
- 設定檔結構變更，但保持向後相容
- 需要更新規格文件

---

## 向後相容性說明

### 設定檔向後相容

1. **週報排程設定**：
   - ✅ 仍支援舊的 `schedule: "monday 08:00"` 格式
   - ✅ 新系統會自動解析並轉換為 `schedule_struct`

2. **通知設定**：
   - ✅ 仍支援 `ciso_email` 和 `it_email`
   - ✅ 仍支援 `to_address`（作為預設收件者）
   - ✅ 新系統會自動映射到 `recipients` 結構

### API 向後相容

1. **`GET /api/config`**：
   - ✅ 返回新舊格式的混合結構（向後相容）

2. **`POST /api/config`**：
   - ✅ 接受新舊格式的設定更新

---

## 測試建議

### 功能測試

1. **週報排程可視化設定**：
   - [ ] 透過 Web 界面調整排程時間
   - [ ] 驗證排程器正確重排程
   - [ ] 驗證排程在指定時間執行

2. **週報排程監視**：
   - [ ] 驗證事件記錄正確顯示
   - [ ] 驗證測試寄送功能正常

3. **通知設定結構**：
   - [ ] 驗證新結構設定正確保存
   - [ ] 驗證向後相容性（舊格式仍可讀取）

4. **週報報告生成**：
   - [ ] 驗證 CISO 收件者收到 CISO 週報
   - [ ] 驗證 IT 收件者收到 IT 工單彙總
   - [ ] 驗證同時包含 CISO 和 IT 時，兩種報告都生成

---

## 備註

1. **規格版本**：建議將規格文件版本更新為 v1.2，以反映這些變更

2. **文件維護**：建議建立定期檢視機制，確保規格文件與實際實作保持一致

3. **變更追蹤**：未來所有規格相關變更都應記錄在此文件中

---

**最後更新**：2025-11-16  
**下次檢視**：建議每週檢視一次，確保規格文件與實作一致

