# AETIM 系統技術規格文件

## 文件資訊

**專案名稱**：AI 驅動之自動化威脅情資管理系統 (AETIM)  
**文件版本**：v1.2  
**最後更新**：2025年11月16日  
**文件狀態**：已完成階段一至階段四（Web 管理界面），包含週報排程可視化設定與通知設定結構化

---

## 目錄

1. [系統概述](#系統概述)
2. [技術架構](#技術架構)
3. [資料庫設計](#資料庫設計)
4. [模組規格](#模組規格)
5. [API 規格](#api-規格)
6. [設定檔規格](#設定檔規格)
7. [部署規格](#部署規格)
8. [安全規格](#安全規格)

---

## 系統概述

### 系統目標
建立一個自動化流程，主動收集、分析外部威脅情資，並與內部資產進行關聯性分析，最終產出可行動的報告，並即時通知相關人員。

### 核心功能
1. **威脅情資收集**：從多個公開與官方來源自動收集威脅情資
2. **關聯分析**：比對威脅與內部資產，計算風險分數
3. **報告生成**：生成不同受眾的報告（管理層與技術層）
4. **通知機制**：根據風險等級發送差異化通知

### 系統架構圖
```
┌─────────────────────────────────────────────────────────┐
│                    AETIM 系統架構                        │
├─────────────────────────────────────────────────────────┤
│                                                         │
│  ┌──────────────┐    ┌──────────────┐    ┌──────────┐   │
│  │  Scheduler   │───▶│  Collectors  │───▶│   DB     │   │
│  │  (排程器)     │    │  (收集器)     │    │ (資料庫)  │   │
│  └──────────────┘    └──────────────┘    └──────────┘   │
│         │                    │                 │        │
│         │                    ▼                 │        │
│         │            ┌──────────────┐          │        │
│         │            │  Correlation │          │        │
│         │            │   Engine     │          │        │
│         │            │ (關聯引擎)    │          │        │
│         │            └──────────────┘          │        │
│         │                    │                 │        │
│         ▼                    ▼                 ▼        │
│  ┌──────────────┐    ┌──────────────┐    ┌──────────┐   │
│  │  Reporting   │    │ Notification │    │ Reports  │   │
│  │   Engine     │    │   Handler    │    │ (報告)    │   │
│  └──────────────┘    └──────────────┘    └──────────┘   │
│                                                         │
└─────────────────────────────────────────────────────────┘
```

---

## 技術架構

### 執行環境
- **容器化**：Docker + Docker Compose
- **作業系統**：Linux（Alpine/Ubuntu base image）
- **Python 版本**：3.10+

### 核心技術棧

#### 資料處理
- **SQLite 3**：輕量級關聯式資料庫
- **Pandas**：高效能資料分析與比對

#### 網路與 API
- **requests**：HTTP 請求庫（REST API 呼叫）
- **feedparser**：RSS/Atom Feed 解析

#### 排程管理
- **APScheduler**：進階排程器（支援 Interval 與 Cron）

#### 報告生成
- **Jinja2**：模板引擎（HTML 報告）
- **reportlab**（選用）：PDF 生成

#### AI 功能
- **openai**：OpenAI API 客戶端（GPT-4 用於威脅摘要）

### 依賴套件清單
詳見 `requirements.txt`：
```
requests>=2.31.0
feedparser>=6.0.10
pandas>=2.0.0
sqlalchemy>=2.0.0
apscheduler>=3.10.0
jinja2>=3.1.0
openai>=1.0.0
pyyaml>=6.0
python-dotenv>=1.0.0
```

---

## 資料庫設計

### 資料庫系統
- **類型**：SQLite 3
- **檔案位置**：`aetim.db`（專案根目錄）

### 資料表結構

#### 1. T_Assets（資產清冊）
| 欄位名稱 | 類型 | 說明 | 備註 |
|---------|------|------|------|
| id | INTEGER | 主鍵 | AUTO_INCREMENT |
| hostname | TEXT | 主機名稱 | NOT NULL |
| ip_address | TEXT | IP 位址 | |
| os_version | TEXT | 作業系統版本 | |
| applications | TEXT | 應用程式清單 | |
| owner | TEXT | 負責人 | |
| business_criticality | TEXT | 業務關鍵性 | 高/中/低 |
| data_sensitivity | TEXT | 資料敏感度 | 高/中/低 |
| is_public | TEXT | 是否對外暴露 | Y/N |
| created_at | TIMESTAMP | 建立時間 | DEFAULT CURRENT_TIMESTAMP |
| updated_at | TIMESTAMP | 更新時間 | DEFAULT CURRENT_TIMESTAMP |

#### 2. T_Raw_Intel（原始情資）
| 欄位名稱 | 類型 | 說明 | 備註 |
|---------|------|------|------|
| id | INTEGER | 主鍵 | AUTO_INCREMENT |
| source | TEXT | 情資來源 | CISA_KEV, NVD, RSS_VMWARE, RSS_MSRC, RSS_TWCERT |
| intel_type | TEXT | 情資類型 | CVE, IOC_REPORT |
| cve_id | TEXT | CVE 編號 | |
| title | TEXT | 標題/描述 | |
| description | TEXT | 詳細描述 | |
| cvss_score | REAL | CVSS 分數 | 0.0-10.0 |
| raw_data | TEXT | 原始 JSON 資料 | JSON 格式 |
| status | TEXT | 狀態 | 'new', 'processed', 'logged_no_match' |
| discovered_at | TIMESTAMP | 發現時間 | |
| collected_at | TIMESTAMP | 收集時間 | DEFAULT CURRENT_TIMESTAMP |

#### 3. T_Validated_Threats（已驗證威脅）
| 欄位名稱 | 類型 | 說明 | 備註 |
|---------|------|------|------|
| id | INTEGER | 主鍵 | AUTO_INCREMENT |
| intel_id | INTEGER | 原始情資 ID | FK → T_Raw_Intel.id |
| asset_id | INTEGER | 資產 ID | FK → T_Assets.id |
| cve_id | TEXT | CVE 編號 | |
| risk_score | REAL | 風險分數 | 0.0-10.0 |
| status | TEXT | 處理狀態 | 'new', 'in_progress', 'resolved', 'closed' |
| matched_product | TEXT | 匹配的產品名稱 | |
| risk_analysis | TEXT | 風險分析說明 | JSON 格式 |
| created_at | TIMESTAMP | 建立時間 | DEFAULT CURRENT_TIMESTAMP |
| updated_at | TIMESTAMP | 更新時間 | DEFAULT CURRENT_TIMESTAMP |
| resolved_at | TIMESTAMP | 解決時間 | |

---

## 模組規格

### 1. collectors.py（情資收集器）

#### 功能概述
負責從多個威脅情資來源收集原始資料。

#### 主要函數

##### `fetch_cisa_kev(db_conn, config)`
- **功能**：從 CISA KEV Catalog 收集已知遭利用漏洞
- **來源**：`https://www.cisa.gov/sites/default/files/feeds/known_exploited_vulnerabilities.json`
- **優先級**：P0（緊急）
- **輸出**：寫入 `T_Raw_Intel` 資料表

##### `fetch_nvd(db_conn, config)`
- **功能**：從 NVD API 查詢新 CVEs
- **來源**：`https://services.nvd.nist.gov/rest/json/cves/2.0`
- **優先級**：P1（高）
- **查詢邏輯**：根據 PIR 關鍵字查詢過去 24 小時的新 CVEs
- **輸出**：寫入 `T_Raw_Intel` 資料表

##### `fetch_rss_feeds(db_conn, config)`
- **功能**：從 RSS Feeds 收集安全通報
- **來源**：
  - VMware VMSA: `https://www.vmware.com/security/advisories.xml`
  - MSRC: `https://msrc.microsoft.com/update-guide/rss`
  - TWCERT/CC: `https://www.twcert.org.tw/tw/rss-1-1.xml`
- **優先級**：P1/P2（高/中）
- **輸出**：寫入 `T_Raw_Intel` 資料表

---

### 2. correlation_engine.py（關聯分析引擎）

#### 功能概述
比對原始情資與內部資產，計算風險分數，產出已驗證威脅。

#### 主要函數

##### `run_correlation_analysis(db_conn, config)`
- **功能**：執行完整的關聯分析流程
- **流程**：
  1. 載入資產清單（從 `T_Assets`）
  2. 提取新情資（從 `T_Raw_Intel`，`status='new'`）
  3. 迭代比對（CVE 比對、IOC 比對）
  4. 計算風險分數
  5. 寫入 `T_Validated_Threats`

##### `extract_product_name_from_intel(intel_data)`
- **功能**：從情資資料中提取產品名稱
- **返回**：產品名稱列表

##### `match_cve_with_assets(intel_data, df_assets)`
- **功能**：比對 CVE 與資產（使用模糊匹配）
- **返回**：匹配的資產 ID 列表

##### `calculate_risk_score(intel_data, asset_data)`
- **功能**：計算最終風險分數（0-10）
- **基礎分數**：CVSS 分數（若無則預設 7.0）
- **加權因子**：
  - 對外暴露：x1.5
  - 業務關鍵性（高）：x1.3
  - CISA KEV：x2.0
  - 老舊系統（Windows 2008）：x1.2
  - 資料敏感度（高）：x1.1
- **返回**：最終風險分數（上限 10.0）

---

### 3. reporting_engine.py（報告生成引擎）

#### 功能概述
生成不同受眾的報告（管理層與技術層）。

#### 主要函數

##### `generate_weekly_report(db_conn, config)`
- **功能**：生成 CISO 威脅情資週報（管理層）
- **觸發**：排程（每週一上午 8:00）
- **內容**：
  - AI 驅動的執行摘要（150 字內）
  - 關鍵指標（圖表）
  - Top 5 曝險最嚴重的資產
  - 追蹤清單（未關閉的嚴重威脅）
- **格式**：HTML、PDF（選用）
- **返回**：報告資料字典

##### `generate_ai_summary(threats_data, config)`
- **功能**：使用 AI 生成威脅摘要
- **API**：OpenAI GPT-4
- **Prompt**：將技術資料轉化為業務風險描述
- **返回**：150 字內的繁體中文摘要

##### `generate_it_ticket(validated_threat, asset_data, intel_data, config)`
- **功能**：生成單一 IT 維運工單（技術層）
- **觸發**：即時（風險分數 ≥ 7.0 的嚴重威脅）
- **內容**：
  - 受影響資產資訊
  - 威脅描述（CVE）
  - 風險分析
  - 建議行動
- **格式**：TEXT、JSON
- **返回**：工單資料字典

##### `generate_it_tickets_for_high_risk(db_conn, config, risk_threshold=7.0)`
- **功能**：生成高風險威脅 IT 工單彙總（v1.2 新增）
- **觸發**：週報排程時（如果收件者包含 IT）
- **內容**：彙總過去 7 天內所有高風險威脅（風險分數 ≥ threshold）
- **格式**：JSON（包含多個工單的陣列）
- **返回**：工單列表

##### `save_report(report_data, report_type, format)`
- **功能**：儲存報告到檔案
- **路徑**：`reports/yyyy/yyyymm/` 目錄結構（按年月自動分類）
  - 例如：`reports/2025/202511/` 表示 2025年11月的報告
  - 例如：`reports/2025/202512/` 表示 2025年12月的報告
- **命名**：`{report_type}_{timestamp}.{format}`
- **完整路徑範例**：`reports/2025/202511/ciso_weekly_20251105_093111.html`
- **返回**：檔案路徑

---

### 4. notification_handler.py（通知處理器）

#### 功能概述
管理通知工作流，根據風險等級發送差異化通知。

#### 主要函數

##### `notify_critical_threat(threat_data, config)`
- **功能**：通知嚴重威脅（風險分數 ≥ 9.0）
- **觸發**：即時
- **收件人**：IT 負責人 + CISO
- **內容**：IT 工單 + 緊急警報

##### `check_and_notify_critical_threats(db_conn, config)`
- **功能**：檢查並通知所有新的嚴重威脅
- **查詢**：`T_Validated_Threats`（`status='new'` 且 `risk_score >= 9.0`）

##### `notify_high_risk_summary(db_conn, config)`
- **功能**：通知高風險威脅摘要（風險分數 7.0-9.0）
- **觸發**：每日彙總（排程）
- **內容**：過去 24 小時的高風險威脅清單

##### `notify_weekly_report(report_filepath, config, target_email=None)`
- **功能**：發送管理層週報（CISO 週報）
- **觸發**：排程（可透過 Web 界面設定時間）
- **內容**：HTML 報告（Email 內文 + 附件）
- **參數**：
  - `report_filepath`：CISO 週報檔案路徑
  - `config`：設定檔
  - `target_email`：指定收件者（可選，預設從設定檔讀取）

##### `notify_it_tickets(report_filepath, config, target_email=None)`
- **功能**：發送 IT 工單報告（v1.2 新增）
- **觸發**：週報排程時（如果收件者包含 IT）
- **內容**：IT 工單彙總報告（文字摘要 + JSON 附件）
- **參數**：
  - `report_filepath`：IT 工單報告檔案路徑（JSON 格式）
  - `config`：設定檔
  - `target_email`：指定收件者（可選，預設從設定檔讀取）

##### `send_email(subject, body, to_address, ...)`
- **功能**：發送 Email 通知
- **協定**：SMTP（支援 TLS）
- **參數**：SMTP 伺服器、埠號、認證資訊

---

### 5. scheduler.py（主排程器）

#### 功能概述
管理所有自動化任務的排程與執行。

#### 主要功能

##### 排程任務
1. **收集與關聯分析**：
   - 間隔：可設定（小時或分鐘）
   - 預設：每 4 小時
   - 執行：`run_all_collectors()`

2. **週報生成**：
   - 排程：可透過 Web 界面設定（預設：每週一上午 8:00）
   - 執行邏輯（v1.2 更新）：
     - 根據 `notification.types.weekly_report.recipients` 決定生成哪些報告
     - 如果收件者包含 `ciso`：生成 CISO 週報並發送
     - 如果收件者包含 `it`：生成 IT 工單彙總報告並發送
     - 支援同時生成兩種報告並分別發送給對應收件者
   - 執行函數：`generate_weekly_report()` / `generate_ciso_weekly_report()` + `generate_it_tickets_for_high_risk()` + `notify_weekly_report()` / `notify_it_tickets()`

##### 信號處理
- **SIGUSR1**：立即觸發收集任務（Unix/Linux）
- **SIGUSR2**：重新載入週報排程（v1.2 新增，用於動態調整排程時間）

##### 立即觸發
- **方式一**：執行 `trigger_collectors.py` 腳本
- **方式二**：發送 SIGUSR1 信號

##### 自動啟動功能
- **啟動時自動執行**：服務啟動後，若排程狀態為啟用，自動觸發收集＋分析＋CISO 報告生成

---

### 6. web_app.py（Web 管理界面）

#### 功能概述
提供完整的 Web 管理界面，讓使用者透過瀏覽器管理系統設定、監控任務執行狀態、生成報告和發送通知。

#### 主要功能

##### Flask Web 應用程式
- **框架**：Flask + Flask-CORS
- **端口**：5000（容器內），5001（主機，避免 macOS AirPlay 衝突）
- **模式**：開發模式（生產環境建議使用 Gunicorn）

##### RESTful API 端點

**設定相關：**
- `GET /api/config` - 取得當前設定
- `POST /api/config` - 更新系統設定（排程、通知）

**任務控制：**
- `POST /api/trigger/collectors` - 觸發收集任務
- `POST /api/trigger/correlation` - 觸發關聯分析
- `POST /api/trigger/all` - 觸發所有任務（收集 + 關聯分析）

**狀態查詢：**
- `GET /api/status` - 取得任務執行狀態
- `GET /api/scheduler/next-run` - 取得下次執行時間和倒數計時

**報告生成：**
- `POST /api/report/generate` - 生成報告
  - 參數：`type`（ciso_weekly/it_ticket）、`format`（html/text/json）

**通知處理：**
- `POST /api/notify` - 發送通知
  - 參數：`notification_type`（critical/high_daily/weekly_report）、`recipients`（ciso/it/both）
- `POST /api/smtp/test` - 測試 SMTP 連線和寄送功能

##### 狀態管理
- **task_status**：全域字典，追蹤各任務執行狀態（idle/running/completed/error）
- **scheduler_state**：全域字典，追蹤排程狀態（last_execution_time、next_execution_time、interval_minutes、enabled）

##### 背景任務執行
- 使用 Threading 執行長時間運行的任務（收集、分析、報告生成、通知）
- 避免阻塞主執行緒，確保 Web 界面響應性

##### 啟動任務
- **startup_tasks()**：服務啟動時自動執行
- 當排程狀態為啟用時，自動觸發收集＋分析＋CISO 報告生成

---

## API 規格

### 外部 API 整合

#### 1. CISA KEV API
- **端點**：`https://www.cisa.gov/sites/default/files/feeds/known_exploited_vulnerabilities.json`
- **方法**：GET
- **認證**：無
- **回應格式**：JSON
- **備用 URL**：已實作自動切換機制

#### 2. NVD API v2.0
- **端點**：`https://services.nvd.nist.gov/rest/json/cves/2.0`
- **方法**：GET
- **認證**：API Key（選填，建議）
- **速率限制**：無 API Key 時 5 req/30s，有 API Key 時 50 req/30s
- **回應格式**：JSON

#### 3. OpenAI API
- **端點**：`https://api.openai.com/v1/chat/completions`
- **方法**：POST
- **認證**：Bearer Token（API Key）
- **模型**：GPT-4（或 GPT-3.5-turbo）
- **用途**：威脅摘要生成

### Web API 端點（Web 管理界面）

#### 設定相關
- **GET /api/config**
  - 功能：取得當前系統設定
  - 回應：JSON 格式的設定檔內容

- **POST /api/config**
  - 功能：更新系統設定
  - 參數：JSON body（scheduler、notification 等設定）
  - 回應：成功或錯誤訊息

#### 任務控制
- **POST /api/trigger/collectors**
  - 功能：立即觸發收集任務
  - 回應：任務啟動狀態

- **POST /api/trigger/correlation**
  - 功能：立即觸發關聯分析
  - 回應：任務啟動狀態

- **POST /api/trigger/all**
  - 功能：觸發所有任務（收集 + 關聯分析）
  - 回應：任務啟動狀態

#### 狀態查詢
- **GET /api/status**
  - 功能：取得任務執行狀態
  - 回應：JSON 格式的任務狀態字典

- **GET /api/scheduler/next-run**
  - 功能：取得下次執行時間和倒數計時
  - 回應：JSON 格式（next_execution_time、countdown）

#### 報告生成
- **POST /api/report/generate**
  - 功能：生成報告
  - 參數：JSON body
    - `type`：報告類型（ciso_weekly/it_ticket）
    - `format`：報告格式（html/text/json）
  - 回應：報告生成狀態和檔案路徑

#### 通知處理
- **POST /api/notify**
  - 功能：發送通知
  - 參數：JSON body
    - `notification_type`：通知類型（critical/high_daily/weekly_report）
    - `recipients`：收件者（ciso/it/both）
  - 回應：通知發送狀態

- **POST /api/smtp/test**
  - 功能：測試 SMTP 連線和寄送功能
  - 參數：JSON body（SMTP 設定）
  - 回應：測試結果（成功/失敗及詳細訊息）

---

## 設定檔規格

### config.yaml 結構

```yaml
# 1. 資料庫設定
database:
  file: "aetim.db"

# 2. 資產清單路徑
assets:
  csv_file: "資產清單 - Sheet1.csv"

# 3. API 金鑰（從環境變數讀取）
api_keys:
  nvd: "${NVD_API_KEY}"
  openai: "${OPENAI_API_KEY}"

# 4. 情資來源
threat_feeds:
  cisa_kev: "https://..."
  vmware_vmsa: "https://..."
  msrc_rss: "https://..."
  twcert_rss: "https://..."

# 5. PIR 關鍵字
pir_keywords:
  - "VMware ESXi 7.0"
  - "Windows Server 2016"
  # ...

# 6. 排程器設定
scheduler:
  interval:
    hours: 4        # 小時設定（可設為 null 表示不使用）
    minutes: null   # 分鐘設定（可設為 null 表示不使用）
    # 注意：小時和分鐘不能同時為 null，至少需設定一個

# 7. 報告與通知設定
reporting:
  weekly_report:
    enabled: true
    schedule: "monday 08:00"  # 舊格式（保留向後相容）
    schedule_struct:  # 新格式（v1.2 新增，優先使用）
      day_of_week: mon     # mon,tue,wed,thu,fri,sat,sun
      hour: 8              # 0-23
      minute: 0            # 0-59
      timezone: Asia/Taipei
  output_dir: "./reports"  # 報告將自動儲存在 reports/yyyy/yyyymm/ 目錄結構中
  templates:
    ciso_weekly:
      enabled: true
      format: ["html", "pdf"]
      include_ai_summary: true
    it_ticket:
      enabled: true
      format: ["text", "json"]

notification:
  enabled: true  # 頂層通知功能開關
  email:
    enabled: true  # Email 通知開關
    smtp_server: "smtp.gmail.com"
    smtp_port: 587
    smtp_username: "${EMAIL_USERNAME}"
    smtp_password: "${EMAIL_PASSWORD}"  # 支援環境變數或加密字串
    from_address: "${EMAIL_FROM}"
    to_address: "${EMAIL_TO}"  # 預設收件者（保留向後相容）
    use_tls: true
    # 以下欄位保留向後相容，建議使用新的 recipients 結構
    ciso_email: "ciso@yourcompany.com"  # CISO 收件者 Email（v1.1，保留）
    it_email: "it@yourcompany.com"      # IT 團隊收件者 Email（v1.1，保留）
  # 收件者群組（v1.2 新增，統一管理）
  recipients:
    ciso: "ciso@yourcompany.com"  # CISO 收件者 Email
    it: "it@yourcompany.com"      # IT 收件者 Email
  # 通知類型設定（v1.2 新增，每種類型可獨立設定）
  types:
    critical:  # 嚴重威脅通知
      enabled: true
      recipients: [it, ciso]  # 收件者群組
      threshold: 9.0          # 風險分數閾值
    high_daily:  # 高風險每日摘要
      enabled: true
      recipients: [it]
      threshold: 7.0
      schedule: "09:00"  # 每日發送時間（HH:MM）
    weekly_report:  # 週報通知
      enabled: true
      recipients: [ciso]  # 可設定為 [ciso], [it], 或 [ciso, it]
  # 以下欄位保留向後相容
  thresholds:
    critical: 9.0
    high: 7.0
    medium: 4.0
  channels:
    email: true
```

---

## 部署規格

### Docker 部署

#### Dockerfile
- **基礎映像**：`python:3.10-slim-bullseye`
- **工作目錄**：`/app`
- **時區設定**：`Asia/Taipei`（安裝 tzdata 套件並設定時區）
- **啟動命令**：
  - `aetim` 服務：`python scheduler.py`
  - `aetim-web` 服務：`python web_app.py`

#### docker-compose.yml
- **服務名稱**：
  - `aetim`：排程器服務
  - `aetim-web`：Web 管理界面服務
- **Volume 映射**：`.:/app`
- **環境變數**：從 `.env` 檔案讀取
- **時區設定**：`TZ=Asia/Taipei`（v1.1 新增）
- **自動重啟**：`restart: unless-stopped`（v1.1 新增）
- **端口映射**：`5001:5000`（aetim-web 服務）

### 環境變數

#### .env 檔案範例
```bash
# NVD API 金鑰（選填）
NVD_API_KEY=your_nvd_api_key_here

# OpenAI API 金鑰（選填）
OPENAI_API_KEY=your_openai_api_key_here

# Email 設定（選填）
EMAIL_USERNAME=your_email@gmail.com
EMAIL_PASSWORD=your_app_password
EMAIL_FROM=your_email@gmail.com
EMAIL_TO=ciso@company.com
```

---

## 安全規格

### 資料安全
- **API 金鑰**：儲存在環境變數中，不寫入程式碼
- **資料庫**：SQLite 檔案權限控制（建議 600）
- **敏感資料**：不記錄在日誌中

### 網路安全
- **HTTPS**：所有外部 API 呼叫使用 HTTPS
- **TLS**：Email 通知使用 TLS（SMTP port 587）

### 存取控制
- **檔案權限**：Docker 容器內以非 root 使用者執行（建議）
- **目錄隔離**：報告目錄獨立，避免敏感資料洩露
- **目錄結構**：報告按年月自動分類儲存（`reports/yyyy/yyyymm/`），便於管理與查找

### 時區管理（v1.1 新增）
- **統一時區**：所有時間戳記統一使用 `Asia/Taipei`（UTC+8）
- **後端處理**：使用 `zoneinfo.ZoneInfo('Asia/Taipei')` 和 `get_taipei_time()` 函數
- **前端顯示**：JavaScript `toLocaleString()` 明確指定 `timeZone: 'Asia/Taipei'`
- **報告檔名**：報告檔案命名使用 Asia/Taipei 時區的時間戳記

---

## 效能規格

### 收集頻率
- **CISA KEV**：每 1 小時（建議）
- **NVD**：每 4 小時（可調整）
- **RSS Feeds**：每 4 小時（可調整）

### 處理能力
- **資料庫大小**：SQLite 支援數百萬筆記錄
- **並發處理**：單執行緒（可擴展為多執行緒）

### 資源需求
- **記憶體**：建議 512MB 以上
- **儲存空間**：建議 1GB 以上（含報告檔案）

---

## 錯誤處理

### 錯誤類型
1. **網路錯誤**：API 連線失敗、超時
2. **資料錯誤**：JSON 解析失敗、資料格式不符
3. **資料庫錯誤**：連線失敗、SQL 語法錯誤
4. **AI API 錯誤**：API 金鑰無效、配額用盡

### 錯誤處理策略
- **重試機制**：網路錯誤自動重試（最多 3 次）
- **備用 URL**：CISA KEV 已實作備用 URL
- **預設值**：CVSS 分數缺失時使用預設值 7.0
- **錯誤日誌**：記錄所有錯誤至標準錯誤輸出

---

## 測試規格

### 單元測試
- 各模組的獨立功能測試
- 資料庫操作測試

### 整合測試
- 端對端流程測試
- API 整合測試

### 效能測試
- 大量資料處理測試
- 並發請求測試

---

**文件版本**：v1.1  
**最後更新**：2025年11月6日  
**文件狀態**：已完成階段一至階段四（Web 管理界面）

## 版本歷史

### v1.1 (2025年11月6日)
- **新增**：Web 管理界面（階段四）
- **新增**：下次執行時間倒數顯示功能
- **新增**：動態排程設定增強（小時＋分鐘組合）
- **新增**：多收件者 Email 設定（CISO、IT 團隊分離）
- **新增**：SMTP 設定獨立區塊與測試功能
- **新增**：系統自動啟動功能
- **新增**：時區統一設定（Asia/Taipei）
- **修正**：Email 通知功能未啟用檢查邏輯
- **修正**：報告檔案路徑顯示優化
- **修正**：處理狀態與報告顯示問題

### v1.0 (2025年11月3日)
- 初始版本：階段一至階段三規格定義


