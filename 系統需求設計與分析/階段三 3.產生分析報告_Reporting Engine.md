##### 階段三：3.產生分析報告 (Reporting Engine)
> 目標： 自動產生兩種不同受眾的報告：(A) 您（資安官）需要的管理摘要 (B) IT 團隊需要的技術工單。 觸發時機： 1. 定期排程 (如每週一) 2. 即時觸發 (當階段二發現嚴重威脅時)。 Python 實現 (reporting_engine.py)：
> 
> 我們將使用 Python 的 jinja2 函式庫來套用報告模板，並可輸出為 HTML (Email) 或 PDF (附件)。
--- 
###### 報告模板 A：CISO 威脅情資週報 (管理層)
- 受眾： 資安官（您）。
- 觸發： 排程執行（例如：每週一上午 8:00）。
- 格式： HTML Email + PDF 附件。
- 內容：
1. AI 驅動的執行摘要 (AI Application Point)：
   - 腳本邏輯： 程式會抓取 T_Validated_Threats 中過去 7 天所有「高」風險以上的威脅。
   - AI 任務： 將這些技術資料 (CVE, Asset) 傳送給 LLM API，並下達指令：
    "你是一位企業資安諮詢顧問。請用 150 字內的繁體中文，總結以下威脅對本公司（一家擁有對外文件倉儲系統的公司）的潛在業務衝擊，並建議本週的管理層應關注的焦點。"
2. 關鍵指標 (Key Metrics)：
   - 圖表：本週新增威脅 (依風險等級：嚴重/高/中)。
   - 圖表：本週已修復威脅 v.s. 待處理威脅。
   - 清單：Top 5 曝險最嚴重的資產 (依 final_score 總和排序)。
3. 追蹤清單： 摘要上週未關閉的嚴重威脅，及其目前狀態。

###### 報告模板 B：IT 維運工單 (技術層)
- 受眾： IT 工程師（根據 T_Assets.負責人 欄位）。
- 觸發： 即時觸發。當階段二 correlation_engine.py 計算出 final_score > 7.0 (高風險) 時立即生成。
- 格式： 結構化文字（用於 Email / Teams / Slack）或 JSON（用於 API 介接 Jira/ServiceNow）。
- 內容 (精確、可行動)：
    - 受影響資產： [主機名稱] (例如：資料庫伺服器主機)
    - IP： [IP] (例如：10.6.82.25)
    - 威脅名稱： [CVE-ID 或威脅描述]
    - 風險分數： [Score] (例如：9.8 / 10.0)
    - 風險分析： (例如：CVSS 9.8 * CISA KEV (x2.0) * 資產關鍵性-高 (x1.3))
    - 情資來源： (例如：CISA KEV List)
    - 建議行動： [修補程式連結或緩解措施] (例如：立即安裝 Microsoft KBXXXXXX 更新)
    - 資產負責人： [負責人] (例如：工程師)

--- 

##### 階段四：通知資安官 (Notification Workflow)
> 目標： 建立一個差異化的通知矩陣。**「緊急」的威脅必須立即處理；「重要」**的威脅則彙總報告，避免警報疲勞。 Python 實現 (notification_handler.py)：
> 這是一個 Python 模組，負責處理訊息的「路由」。
> 使用 smtplib (Email)、requests (Teams/Slack/Jira API)。

###### 工作流 1：嚴重威脅 (Critical Threat) - (即時觸發)
- 觸發條件： 階段二引擎發現 final_score > 9.0 (例如：CISA KEV 漏洞 + 命中對外主機)。
- 執行順序 (自動化)：
1. [階段三] 立即生成報告 B (IT 工單)。
2. [階段四] (通知 IT)：
    - 方案 A (Email)： 立即發送「報告 B」內容至 T_Assets.負責人 的 Email。
    - 方案 B (API - 建議)： 呼叫 Jira/ServiceNow API，自動建立一個「P0 嚴重」等級的 Ticket，並指派給該「負責人」。
3. [階段四] (通知您)：
    - 立即發送一封「Email 警報」給您（資安官）。
    - 主旨： [AETIM 緊急警報] 發現嚴重威脅 (Risk: 9.8) - 影響 [主機名稱]
    - 內容： 簡要說明威脅，並告知「已自動建立工單 (Ticket #XXXX) 並通知 IT 團隊」。

###### 工作流 2：高風險威脅 (High Threat) - (每日彙總)
- 觸發條件： 7.0 < final_score <= 9.0。
- 執行順序：
1. 不立即發送警報，避免干擾。
2. 系統排程（例如：每日上午 9:00）彙總過去 24 小時內所有「高風險」威脅。
3. [階段四] (通知 IT)： 批次建立「P1 高」等級的 Tickets。
4. [階段四] (通知您)： 發送一封「每日威脅摘要」Email 給您，彙總這些高風險威脅。
###### 工作流 3：管理層週報 (Weekly Report) - (排程)
- 觸發條件： 排程（可透過 Web 界面設定時間，預設：每週一上午 8:00）。
- 執行順序（v1.2 更新）：
1. [階段三] 系統根據 `notification.types.weekly_report.recipients` 決定生成哪些報告：
   - 如果收件者包含 `ciso`：
     - 執行 `generate_ciso_weekly_report()`，生成報告 A (CISO 週報)
     - 呼叫 AI 產生摘要
   - 如果收件者包含 `it`：
     - 執行 `generate_it_tickets_for_high_risk()`，生成 IT 工單彙總報告
     - 彙總過去 7 天內所有高風險威脅（風險分數 ≥ 7.0）
2. [階段四] (通知收件者)：
   - **CISO 收件者**：
     - 發送「Email 報告」給 CISO 收件者
     - 主旨： [AETIM 資安情資週報] (日期範圍)
     - 內容： 包含 AI 摘要、關鍵圖表，並附上完整 HTML 報告
   - **IT 收件者**：
     - 發送「IT 工單週報」給 IT 收件者
     - 主旨： [AETIM IT 工單週報] (日期範圍) - X 個高風險威脅
     - 內容： 工單摘要列表，並附上完整 JSON 報告檔案

**說明**：
- IT 工單有兩種觸發方式：
  1. **即時觸發**：當發現嚴重威脅（風險分數 ≥ 9.0）時立即生成並發送單一工單
  2. **週報彙總**：每週排程時，彙總過去 7 天的高風險威脅（風險分數 ≥ 7.0）生成彙總報告
- 週報排程可同時生成兩種報告，分別發送給對應的收件者群組

--- 
##### 總結：完整的 AETIM 循環
資安官，至此，我們已設計了完整的自動化循環：
- 階段一 (定義)： 知道要保護什麼 (資產清單) 和監控什麼 (PIRs)。
- 階段二 (分析)： Python 引擎 (Collection + Correlation) 自動收集情資、比對資產、計算風險分數 (T_Validated_Threats)。
- 階段三 (報告)： Python 引擎 (Reporting) 將技術資料轉化為 AI 摘要的管理報告 (給您) 和技術工單 (給 IT)。
- 階段四 (通知)： Python 引擎 (Notification) 根據風險分數，執行差異化的通知（即時警報 vs. 每日/每週摘要）。

這套系統不僅能自動化蒐集情資工作，其產出的報告 **A (週報)** 和報告 **B (工單)** 及其處理紀錄，將成為向稽核員和客戶證明 ***ISO 27001 A.5.7 (威脅情資) 控制項***已具體落實的絕佳佐證。


