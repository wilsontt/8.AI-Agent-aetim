# AETIM Web 界面問題修正 - 測試指南

**測試日期：** 2025年11月06日  
**測試版本：** v1.0  
**測試人員：** AETIM 開發團隊

---

## 📋 測試前準備

### 1. 確認服務狀態

```bash
cd "/Users/wilson/Documents/5. Projects/8. 自動蒐集威脅情報AI-Agent代理人工具/aetim"
docker-compose ps
```

**預期結果：**
- `aetim_service` 狀態：Up
- `aetim_web_service` 狀態：Up，端口映射 `0.0.0.0:5001->5000/tcp`

### 2. 訪問 Web 界面

在瀏覽器中打開：
```
http://localhost:5001
```

---

## 🧪 測試項目

### 測試項目 1：排程時間計算與倒數顯示

#### 測試步驟：
1. 訪問 Web 界面
2. 查看「基本排程功能」區域的「下次執行時間」欄位
3. 觀察倒數時間是否正常顯示（例如：「3小時 45分鐘 30秒」）
4. 等待 10 秒，觀察倒數時間是否自動更新

#### 預期結果：
- ✅ 下次執行時間顯示具體的倒數時間（非「計算中...」）
- ✅ 倒數時間每 10 秒自動更新
- ✅ 時間格式正確（小時、分鐘、秒）

#### 驗證方法：
- 檢查瀏覽器開發者工具（F12）的 Network 標籤
- 確認每 10 秒有請求 `/api/scheduler/next-run`
- 檢查回應內容是否包含 `countdown_str`

---

### 測試項目 2：動態排程設定 UI 改進

#### 測試步驟：
1. 查看「動態排程設定」區域
2. 確認「執行間隔（小時）」和「執行間隔（分鐘）」是否並排顯示
3. 檢查「執行間隔（小時）」下拉選單是否包含「不使用」選項
4. 檢查「執行間隔（分鐘）」下拉選單是否包含「不使用」選項

#### 預期結果：
- ✅ 小時和分鐘選項並排顯示（在同一行）
- ✅ 小時選項包含「不使用」選項
- ✅ 分鐘選項包含「不使用」選項

---

### 測試項目 3：排程間隔計算邏輯（小時+分鐘）

#### 測試步驟：
1. 設定「執行間隔（小時）」為「1 小時」
2. 設定「執行間隔（分鐘）」為「30 分鐘」
3. 點擊「更新排程設定」按鈕
4. 觀察「下次執行時間」是否顯示「1小時 30分鐘」的倒數時間

#### 預期結果：
- ✅ 間隔時間 = 1小時 + 30分鐘 = 90分鐘
- ✅ 下次執行時間正確計算（90分鐘後）
- ✅ 倒數時間顯示正確

#### 測試案例：
- **案例 1**：小時=1，分鐘=30 → 總間隔=90分鐘
- **案例 2**：小時=0（不使用），分鐘=15 → 總間隔=15分鐘
- **案例 3**：小時=2，分鐘=0（不使用）→ 總間隔=120分鐘

---

### 測試項目 4：排程設定驗證

#### 測試步驟：
1. 將「執行間隔（小時）」設為「不使用」
2. 將「執行間隔（分鐘）」設為「不使用」
3. 點擊「更新排程設定」按鈕
4. 觀察是否顯示錯誤訊息

#### 預期結果：
- ✅ 顯示錯誤訊息：「錯誤：小時和分鐘不能同時選擇「不使用」，請至少選擇一個。」
- ✅ 設定不會被保存

---

### 測試項目 5：倒數時間重新計算觸發

#### 測試步驟 5.1：設定更新後重新計算
1. 記錄當前的「下次執行時間」
2. 修改「動態排程設定」（例如：將小時從 4 改為 6）
3. 點擊「更新排程設定」
4. 觀察「下次執行時間」是否立即重新計算

#### 預期結果：
- ✅ 設定更新後，倒數時間立即重新計算
- ✅ 新的倒數時間基於新的設定

---

#### 測試步驟 5.2：手動觸發後重新計算
1. 記錄當前的「下次執行時間」
2. 點擊「觸發收集任務」按鈕
3. 等待任務完成
4. 觀察「下次執行時間」是否重新計算

#### 預期結果：
- ✅ 任務執行完成後，倒數時間重新計算
- ✅ 新的倒數時間從當前時間開始計算

---

#### 測試步驟 5.3：觸發全部後重新計算
1. 記錄當前的「下次執行時間」
2. 點擊「觸發全部（收集+分析）」按鈕
3. 等待任務完成
4. 觀察「下次執行時間」是否重新計算

#### 預期結果：
- ✅ 任務執行完成後，倒數時間重新計算
- ✅ 新的倒數時間從當前時間開始計算

---

### 測試項目 6：「觸發全部」功能日誌顯示

#### 測試步驟：
1. 點擊「觸發全部（收集+分析）」按鈕
2. 在「收集任務與關聯分析」區域觀察狀態和日誌
3. 確認是否顯示詳細的執行過程

#### 預期結果：
- ✅ 狀態從「閒置」→「執行中」→「已完成」
- ✅ 日誌顯示：
  - `[HH:MM:SS] 開始執行所有收集器...`
  - `[HH:MM:SS] 開始執行 CISA KEV 收集器...`
  - `[HH:MM:SS] CISA KEV 收集器完成`
  - `[HH:MM:SS] 開始執行 NVD 收集器...`
  - `[HH:MM:SS] NVD 收集器完成`
  - `[HH:MM:SS] 開始執行 RSS Feeds 收集器...`
  - `[HH:MM:SS] RSS Feeds 收集器完成`
  - `[HH:MM:SS] 開始關聯分析...`
  - `[HH:MM:SS] 關聯分析完成`

---

### 測試項目 7：報告生成狀態顯示

#### 測試步驟 7.1：CISO 週報生成
1. 在「報告生成」區域選擇「CISO 週報」
2. 選擇格式「HTML」
3. 點擊「生成報告」按鈕
4. 觀察狀態和日誌顯示

#### 預期結果：
- ✅ 狀態從「閒置」→「執行中」→「已完成」
- ✅ 日誌顯示：
  - `[HH:MM:SS] 開始生成 CISO 週報...`
  - `[HH:MM:SS] 報告資料生成完成，正在儲存...`
  - `[HH:MM:SS] 報告已儲存：reports/2025/202511/ciso_weekly_*.html`
- ✅ 顯示報告檔案路徑

---

#### 測試步驟 7.2：IT 工單生成
1. 在「報告生成」區域選擇「IT 工單」
2. 選擇格式「Text」或「JSON」
3. 點擊「生成報告」按鈕
4. 觀察狀態和日誌顯示

#### 預期結果：
- ✅ 狀態從「閒置」→「執行中」→「已完成」或「錯誤」
- ✅ 如果有高風險威脅，日誌顯示：
  - `[HH:MM:SS] 開始生成 IT 工單...`
  - `[HH:MM:SS] 找到高風險威脅，開始生成工單...`
  - `[HH:MM:SS] 工單資料準備完成，開始生成...`
  - `[HH:MM:SS] 工單資料生成完成，正在儲存...`
  - `[HH:MM:SS] 工單已儲存：reports/2025/202511/it_ticket_*.txt`
- ✅ 如果沒有高風險威脅，顯示適當的錯誤訊息
- ✅ 報告檔案成功生成

---

### 測試項目 8：報告檔案驗證

#### 測試步驟：
1. 生成 CISO 週報（HTML 格式）
2. 生成 IT 工單（Text 格式）
3. 檢查報告檔案是否存在

#### 預期結果：
- ✅ CISO 週報檔案存在：`reports/2025/202511/ciso_weekly_YYYYMMDD_HHMMSS.html`
- ✅ IT 工單檔案存在：`reports/2025/202511/it_ticket_YYYYMMDD_HHMMSS.txt`
- ✅ 檔案內容正確

#### 驗證方法：
```bash
# 在容器內檢查檔案
docker-compose exec aetim-web ls -la /app/reports/2025/202511/

# 或在本機檢查（如果已掛載）
ls -la aetim/reports/2025/202511/
```

---

## ✅ 測試檢查清單

### 設定與控制功能
- [ ] 下次執行時間正確顯示倒數時間（非「計算中...」）
- [ ] 倒數時間每 10 秒自動更新
- [ ] 動態排程設定：小時和分鐘並排顯示
- [ ] 動態排程設定：小時選項包含「不使用」
- [ ] 排程間隔計算：小時+分鐘正確相加
- [ ] 排程設定驗證：小時和分鐘不能同時不使用
- [ ] 設定更新後，倒數時間重新計算
- [ ] 手動觸發後，倒數時間重新計算

### 處理狀態與報告功能
- [ ] 「觸發全部」功能顯示詳細日誌
- [ ] 報告生成過程顯示進度訊息
- [ ] CISO 週報成功生成
- [ ] IT 工單成功生成
- [ ] 報告檔案正確儲存

---

## 🐛 已知問題與限制

### 待處理問題：
1. **通知收件者分組**：目前只能設定一個收件者，無法分別設定 CISO 和 IT 團隊
2. **通知訊息顯示**：發送通知後需要顯示收件者 Email
3. **Email 發送問題**：收件者沒有收到 Email（需要排查 SMTP 設定）

---

## 📝 測試結果記錄

### 測試環境
- **作業系統：** macOS 14.1.0
- **Docker：** Docker Compose
- **瀏覽器：** [請填寫]
- **測試時間：** [請填寫]

### 測試結果

| 測試項目 | 狀態 | 備註 |
|---------|------|------|
| 測試項目 1：排程時間計算與倒數顯示 | ⬜ | |
| 測試項目 2：動態排程設定 UI 改進 | ⬜ | |
| 測試項目 3：排程間隔計算邏輯 | ⬜ | |
| 測試項目 4：排程設定驗證 | ⬜ | |
| 測試項目 5.1：設定更新後重新計算 | ⬜ | |
| 測試項目 5.2：手動觸發後重新計算 | ⬜ | |
| 測試項目 5.3：觸發全部後重新計算 | ⬜ | |
| 測試項目 6：「觸發全部」功能日誌顯示 | ⬜ | |
| 測試項目 7.1：CISO 週報生成 | ⬜ | |
| 測試項目 7.2：IT 工單生成 | ⬜ | |
| 測試項目 8：報告檔案驗證 | ⬜ | |

**狀態說明：**
- ✅ 通過
- ❌ 失敗
- ⚠️ 部分通過
- ⬜ 待測試

---

## 🔍 問題回報

如果發現問題，請記錄以下資訊：

1. **問題描述**：
2. **重現步驟**：
3. **預期行為**：
4. **實際行為**：
5. **錯誤訊息**：
6. **瀏覽器控制台錯誤**：
7. **後端日誌**：
   ```bash
   docker-compose logs aetim-web --tail=50
   ```

---

**測試指南結束**

