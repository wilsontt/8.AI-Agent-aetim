# AETIM 時區與通知功能修正計劃

**日期：** 2025年11月06日  
**版本：** v1.0  
**狀態：** 計劃中

---

## 1. 問題概述

根據使用者反饋，系統需要進行以下修正：

### 1.1 通知發送問題
- **問題**：SMTP 連線測試 OK，也有收到測試的信件，但是通知處理的發送通知，並沒有收到信件
- **可能原因**：
  - 通知發送時使用的設定和測試時不同
  - `notify_weekly_report` 函數沒有正確使用傳入的 config
  - SMTP 設定沒有正確傳遞到通知處理器

### 1.2 前端時間顯示問題
- **問題**：處理狀態與報告的每個區域上的時間，都不是 Docker 所預設的時區（Asia/Taipei）
- **原因**：前端使用 `new Date(taskStatus.timestamp).toLocaleString('zh-TW')` 但沒有指定時區，會使用瀏覽器的時區

### 1.3 報告檔名時間問題
- **問題**：生成報告所產生的檔案，檔名的時間也不對
- **原因**：`datetime.now()` 在 Python 中預設使用系統時區，但可能沒有正確使用 Asia/Taipei

### 1.4 報告格式問題
- **問題**：生成報告的檔案格式（問題描述不完整，需要進一步確認）

---

## 2. 修改計劃 (Plan)

### 2.1 通知發送問題修正

#### 2.1.1 問題分析
- **測試 SMTP**：使用 `/api/smtp/test` API，直接傳遞 SMTP 設定，測試成功
- **通知發送**：使用 `notify_weekly_report` 函數，從 config 讀取設定，可能設定不完整

#### 2.1.2 修正方案
1. **檢查 `notify_weekly_report` 函數**：
   - 確認函數正確讀取 config 中的 SMTP 設定
   - 確認函數正確使用 `to_address` 參數
   - 添加詳細的日誌輸出，追蹤設定值

2. **改進設定傳遞**：
   - 確保 `web_app.py` 中傳遞給 `notify_weekly_report` 的 config 包含完整的 SMTP 設定
   - 使用 `copy.deepcopy` 確保設定正確複製（已完成）
   - 驗證所有必要的 SMTP 設定都存在

3. **添加除錯日誌**：
   - 在 `notify_weekly_report` 函數中添加日誌，輸出使用的 SMTP 設定
   - 在 `send_email` 函數中添加日誌，輸出發送過程

### 2.2 前端時間顯示問題修正

#### 2.2.1 問題分析
- 前端使用 `new Date(taskStatus.timestamp).toLocaleString('zh-TW')` 但沒有指定時區
- 瀏覽器會使用系統時區，而不是 Asia/Taipei

#### 2.2.2 修正方案
1. **修改前端時間顯示**：
   - 在 `toLocaleString` 中添加 `timeZone: 'Asia/Taipei'` 選項
   - 確保所有時間戳記顯示都使用 Asia/Taipei 時區

2. **修改時間戳記生成**：
   - 確保後端生成的時間戳記使用 Asia/Taipei 時區
   - 使用 `datetime.now(timezone)` 生成時區感知的時間戳記

### 2.3 報告檔名時間問題修正

#### 2.3.1 問題分析
- `datetime.now()` 在 Python 中預設使用系統時區
- 雖然 Docker 設定了時區，但 Python 的 `datetime.now()` 可能沒有正確使用

#### 2.3.2 修正方案
1. **使用時區感知的 datetime**：
   - 導入 `pytz` 或使用 `zoneinfo`（Python 3.9+）
   - 使用 `datetime.now(timezone('Asia/Taipei'))` 生成時間戳記

2. **修改 `save_report` 函數**：
   - 在生成檔名時使用 Asia/Taipei 時區
   - 確保所有時間戳記都使用正確的時區

### 2.4 報告格式問題確認

#### 2.4.1 需要確認
- 報告格式的具體問題是什麼？
- 是 HTML 格式、JSON 格式還是 TEXT 格式的問題？
- 是內容格式還是檔案格式的問題？

#### 2.4.2 預期修正
- 等待使用者提供更多資訊後再進行修正

---

## 3. 任務清單 (Tasks)

### 3.1 通知發送問題修正

#### Task 1.1: 檢查 `notify_weekly_report` 函數
- **檔案**：`notification_handler.py`
- **任務**：
  - 檢查函數是否正確讀取 config 中的 SMTP 設定
  - 確認函數正確使用 `to_address` 參數
  - 添加詳細的日誌輸出，追蹤設定值
- **預估時間**：1 小時

#### Task 1.2: 改進設定傳遞
- **檔案**：`web_app.py`
- **任務**：
  - 確保傳遞給 `notify_weekly_report` 的 config 包含完整的 SMTP 設定
  - 驗證所有必要的 SMTP 設定都存在
  - 添加驗證邏輯，確保設定完整
- **預估時間**：1.5 小時

#### Task 1.3: 添加除錯日誌
- **檔案**：`notification_handler.py`, `web_app.py`
- **任務**：
  - 在 `notify_weekly_report` 函數中添加日誌，輸出使用的 SMTP 設定
  - 在 `send_email` 函數中添加日誌，輸出發送過程
  - 在 `web_app.py` 中添加日誌，輸出傳遞的設定
- **預估時間**：1 小時

### 3.2 前端時間顯示問題修正

#### Task 2.1: 修改前端時間顯示
- **檔案**：`templates/index.html`
- **任務**：
  - 在 `toLocaleString` 中添加 `timeZone: 'Asia/Taipei'` 選項
  - 確保所有時間戳記顯示都使用 Asia/Taipei 時區
  - 測試時間顯示是否正確
- **預估時間**：1 小時

#### Task 2.2: 修改時間戳記生成
- **檔案**：`web_app.py`
- **任務**：
  - 確保後端生成的時間戳記使用 Asia/Taipei 時區
  - 使用 `datetime.now(timezone)` 生成時區感知的時間戳記
  - 測試時間戳記是否正確
- **預估時間**：1.5 小時

### 3.3 報告檔名時間問題修正

#### Task 3.1: 使用時區感知的 datetime
- **檔案**：`reporting_engine.py`
- **任務**：
  - 導入 `pytz` 或使用 `zoneinfo`（Python 3.9+）
  - 使用 `datetime.now(timezone('Asia/Taipei'))` 生成時間戳記
  - 測試時間戳記是否正確
- **預估時間**：1 小時

#### Task 3.2: 修改 `save_report` 函數
- **檔案**：`reporting_engine.py`
- **任務**：
  - 在生成檔名時使用 Asia/Taipei 時區
  - 確保所有時間戳記都使用正確的時區
  - 測試報告檔名是否正確
- **預估時間**：1 小時

### 3.4 報告格式問題確認

#### Task 4.1: 確認報告格式問題
- **任務**：
  - 等待使用者提供更多資訊
  - 確認問題的具體內容
  - 制定修正方案
- **預估時間**：待定

---

## 4. 技術實作細節

### 4.1 時區處理

#### Python 時區處理
```python
# 方法 1：使用 pytz（需要安裝）
import pytz
from datetime import datetime

taipei_tz = pytz.timezone('Asia/Taipei')
now = datetime.now(taipei_tz)

# 方法 2：使用 zoneinfo（Python 3.9+）
from zoneinfo import ZoneInfo
from datetime import datetime

now = datetime.now(ZoneInfo('Asia/Taipei'))
```

#### JavaScript 時區處理
```javascript
// 使用 toLocaleString 指定時區
const date = new Date(timestamp);
const dateTimeStr = date.toLocaleString('zh-TW', {
    year: 'numeric',
    month: '2-digit',
    day: '2-digit',
    hour: '2-digit',
    minute: '2-digit',
    second: '2-digit',
    hour12: false,
    timeZone: 'Asia/Taipei'  // 明確指定時區
});
```

### 4.2 通知發送除錯

#### 添加日誌輸出
```python
# 在 notify_weekly_report 函數中
print(f"[通知] 使用的 SMTP 設定：")
print(f"  - SMTP 伺服器：{email_config.get('smtp_server')}")
print(f"  - SMTP 埠口：{email_config.get('smtp_port')}")
print(f"  - 發送者：{email_config.get('from_address')}")
print(f"  - 收件者：{to_address}")
print(f"  - 使用 TLS：{email_config.get('use_tls')}")
```

---

## 5. 測試計劃

### 5.1 通知發送測試
- [ ] 測試 SMTP 連線
- [ ] 測試通知發送功能
- [ ] 檢查日誌輸出，確認使用的設定
- [ ] 確認收件者收到 Email

### 5.2 時間顯示測試
- [ ] 檢查前端時間顯示是否使用 Asia/Taipei 時區
- [ ] 檢查後端時間戳記是否使用 Asia/Taipei 時區
- [ ] 對比系統時間和顯示時間，確認正確

### 5.3 報告檔名測試
- [ ] 生成報告，檢查檔名中的時間戳記
- [ ] 確認時間戳記使用 Asia/Taipei 時區
- [ ] 對比系統時間和檔名時間，確認正確

---

## 6. 風險評估

### 6.1 技術風險
- **風險 1**：時區處理可能導致時間不一致
  - **緩解措施**：統一使用 Asia/Taipei 時區，確保所有時間戳記都使用相同的時區

- **風險 2**：通知發送問題可能涉及多個層面
  - **緩解措施**：添加詳細的日誌輸出，逐步排查問題

### 6.2 時程風險
- **風險 1**：報告格式問題需要進一步確認
  - **緩解措施**：先處理其他問題，等待使用者提供更多資訊

---

## 7. 預估時間

### 總預估時間：約 8.5 小時

- **通知發送問題修正**：約 3.5 小時
- **前端時間顯示問題修正**：約 2.5 小時
- **報告檔名時間問題修正**：約 2 小時
- **報告格式問題確認**：待定

---

## 8. 後續維護

### 8.1 文檔更新
- 更新 README.md 中的時區設定說明
- 更新通知功能使用說明

### 8.2 監控與優化
- 監控通知發送成功率
- 收集使用者反饋

---

**計劃結束**

