# AETIM Web 界面問題修正計劃

**日期：** 2025年11月06日  
**版本：** v1.0  
**狀態：** 計劃中

---

## 1. 問題概述

根據使用者反饋，Web 界面存在以下問題需要修正：

### 1.1 設定與控制問題
- **問題 1.1**：基本排程功能中，下次執行時間一直顯示「計算中...」，沒有顯示真正的倒數時間
- **問題 1.2**：下次執行時間需要在特定情況下重新計算（修改設定、服務重啟、手動觸發後）
- **問題 1.3**：動態排程設定缺少「不使用」選項（小時）
- **問題 1.4**：動態排程的間隔時間計算邏輯需要改進（小時+分鐘相加）
- **問題 1.5**：動態排程設定需要並排顯示（小時和分鐘同時選擇）

### 1.2 通知處理問題
- **問題 2.1**：通知人員設定只能設定一個收件者，無法分別設定 CISO 或 IT 團隊不同的收件者

### 1.3 處理狀態與報告問題
- **問題 3.1**：「觸發全部」功能無法看到詳細的訊息狀態，只有「開始執行所有收集器...」和「開始關聯分析...」

### 1.4 報告生成問題
- **問題 4.1**：報告生成過程中沒有任何訊息，都顯示「閒置」
- **問題 4.2**：選擇 IT 工單類型沒有產生報告檔案，只能產生 CISO 週報

### 1.5 通知處理問題
- **問題 5.1**：發送通知後需要顯示收件者的 Email
- **問題 5.2**：收件者沒有收到任何 Email

---

## 2. 修改計劃 (Plan)

### 2.1 架構設計變更

#### 2.1.1 排程時間計算機制
- **新增 API 端點**：`GET /api/scheduler/next-run` - 取得下次執行時間
- **後端邏輯**：
  - 從 APScheduler 取得下次執行時間
  - 計算倒數時間（相對當前時間）
  - 格式化顯示（例如：「2小時 30分鐘後」或「15分鐘後」）
- **前端邏輯**：
  - 每 10 秒自動更新倒數時間
  - 在特定事件時重新計算（設定變更、手動觸發等）

#### 2.1.2 排程設定邏輯改進
- **間隔計算**：小時 + 分鐘（例如：1小時 + 30分鐘 = 90分鐘）
- **優先規則**：
  - 如果小時選擇「不使用」，則使用分鐘
  - 如果分鐘選擇「不使用」，則使用小時
  - 小時和分鐘不能同時選擇「不使用」
- **UI 改進**：小時和分鐘並排顯示，在同一行

#### 2.1.3 通知收件者分組
- **設定結構變更**：
  ```yaml
  notification:
    email:
      recipients:
        ciso: "ciso@company.com"
        it_team: "it-team@company.com"
        default: "security@company.com"
  ```
- **UI 改進**：分別顯示 CISO 和 IT 團隊的收件者設定欄位

#### 2.1.4 任務狀態追蹤改進
- **「觸發全部」功能**：
  - 分別追蹤收集任務和關聯分析的狀態
  - 顯示各階段詳細日誌
  - 類似單獨觸發的訊息顯示方式

#### 2.1.5 報告生成狀態改進
- **狀態更新**：
  - 報告生成開始時更新狀態為「running」
  - 生成過程中顯示進度訊息
  - 完成後更新狀態為「completed」或「error」
- **IT 工單生成修復**：
  - 檢查 `generate_report` API 中的 IT 工單處理邏輯
  - 確保 IT 工單能夠正確生成並保存

#### 2.1.6 通知發送改進
- **通知訊息改進**：
  - 顯示收件者 Email 地址
  - 顯示通知類型
- **Email 發送問題排查**：
  - 檢查 SMTP 設定
  - 檢查 Email 發送邏輯
  - 添加錯誤日誌記錄

---

## 3. 任務清單 (Tasks)

### 3.1 排程時間計算功能

#### Task 1.1: 新增排程時間查詢 API
- **檔案**：`web_app.py`
- **任務**：
  - 新增 `GET /api/scheduler/next-run` API 端點
  - 從 APScheduler 取得下次執行時間
  - 計算倒數時間（秒數）
  - 返回格式化字串
- **預估時間**：2 小時

#### Task 1.2: 前端倒數時間顯示
- **檔案**：`templates/index.html`
- **任務**：
  - 修改 `nextRunTime` 顯示邏輯
  - 實現倒數時間計算（每 10 秒更新）
  - 格式化顯示（小時、分鐘、秒）
- **預估時間**：2 小時

#### Task 1.3: 倒數時間重新計算觸發
- **檔案**：`templates/index.html`, `web_app.py`
- **任務**：
  - 在設定更新後重新計算
  - 在手動觸發後重新計算
  - 在服務重啟後重新計算
- **預估時間**：1.5 小時

### 3.2 動態排程設定改進

#### Task 2.1: 小時選項增加「不使用」
- **檔案**：`templates/index.html`
- **任務**：
  - 在 `intervalHours` select 中增加「不使用」選項（value=""）
  - 調整選項列表
- **預估時間**：0.5 小時

#### Task 2.2: 排程設定 UI 改進（並排顯示）
- **檔案**：`templates/index.html`
- **任務**：
  - 修改 CSS 樣式，使小時和分鐘並排顯示
  - 使用 flexbox 或 grid 布局
- **預估時間**：1 小時

#### Task 2.3: 排程間隔計算邏輯改進
- **檔案**：`web_app.py`, `scheduler.py`
- **任務**：
  - 修改排程更新邏輯
  - 實現小時+分鐘的計算（轉換為總分鐘數）
  - 驗證小時和分鐘不能同時為「不使用」
- **預估時間**：2 小時

#### Task 2.4: 排程設定驗證
- **檔案**：`web_app.py`
- **任務**：
  - 在前端和後端都添加驗證邏輯
  - 確保小時和分鐘不能同時選擇「不使用」
  - 顯示驗證錯誤訊息
- **預估時間**：1.5 小時

### 3.3 通知收件者分組

#### Task 3.1: 通知設定結構變更
- **檔案**：`config.yaml`
- **任務**：
  - 修改通知設定結構，支援多收件者
  - 添加 CISO 和 IT 團隊收件者欄位
- **預估時間**：0.5 小時

#### Task 3.2: 通知設定 UI 改進
- **檔案**：`templates/index.html`
- **任務**：
  - 分別顯示 CISO 和 IT 團隊的收件者輸入欄位
  - 更新設定儲存邏輯
- **預估時間**：1.5 小時

#### Task 3.3: 通知發送邏輯更新
- **檔案**：`web_app.py`, `notification_handler.py`
- **任務**：
  - 根據通知類型選擇對應的收件者（CISO 或 IT 團隊）
  - 更新通知發送邏輯
- **預估時間**：2 小時

### 3.4 任務狀態追蹤改進

#### Task 4.1: 「觸發全部」功能日誌改進
- **檔案**：`web_app.py`
- **任務**：
  - 在 `trigger_all` 函數中添加詳細日誌
  - 分別記錄每個收集器的執行狀態
  - 記錄關聯分析的詳細執行過程
- **預估時間**：2 小時

#### Task 4.2: 狀態顯示改進
- **檔案**：`templates/index.html`
- **任務**：
  - 確保「觸發全部」的狀態和日誌能夠正確顯示
  - 與單獨觸發的顯示方式保持一致
- **預估時間**：1 小時

### 3.5 報告生成狀態改進

#### Task 5.1: 報告生成狀態更新
- **檔案**：`web_app.py`
- **任務**：
  - 確保報告生成開始時狀態更新為「running」
  - 在生成過程中添加進度訊息
  - 完成後正確更新狀態
- **預估時間**：1.5 小時

#### Task 5.2: IT 工單生成修復
- **檔案**：`web_app.py`
- **任務**：
  - 檢查 `generate_report` API 中的 IT 工單處理邏輯
  - 修復 IT 工單生成邏輯
  - 確保 IT 工單能夠正確生成並保存
  - 測試 IT 工單生成功能
- **預估時間**：3 小時

### 3.6 通知處理改進

#### Task 6.1: 通知訊息顯示改進
- **檔案**：`web_app.py`, `templates/index.html`
- **任務**：
  - 在通知發送成功訊息中顯示收件者 Email
  - 顯示通知類型和收件者資訊
- **預估時間**：1 小時

#### Task 6.2: Email 發送問題排查
- **檔案**：`notification_handler.py`
- **任務**：
  - 檢查 SMTP 設定和連線
  - 添加詳細的錯誤日誌
  - 測試 Email 發送功能
  - 修復 Email 發送問題
- **預估時間**：3 小時

---

## 4. 實施順序

### 階段一：核心功能修正（優先級：高）
1. Task 1.1, 1.2, 1.3 - 排程時間計算功能
2. Task 2.1, 2.2, 2.3, 2.4 - 動態排程設定改進
3. Task 5.2 - IT 工單生成修復

### 階段二：功能改進（優先級：中）
4. Task 4.1, 4.2 - 任務狀態追蹤改進
5. Task 5.1 - 報告生成狀態更新

### 階段三：通知功能改進（優先級：中）
6. Task 3.1, 3.2, 3.3 - 通知收件者分組
7. Task 6.1 - 通知訊息顯示改進
8. Task 6.2 - Email 發送問題排查

---

## 5. 測試計劃

### 5.1 功能測試
- [ ] 測試排程時間計算和倒數顯示
- [ ] 測試動態排程設定（小時+分鐘）
- [ ] 測試「觸發全部」功能的狀態顯示
- [ ] 測試報告生成（CISO 週報和 IT 工單）
- [ ] 測試通知收件者分組功能
- [ ] 測試 Email 發送功能

### 5.2 邊界條件測試
- [ ] 測試小時和分鐘同時選擇「不使用」的情況
- [ ] 測試排程設定更新後的時間重新計算
- [ ] 測試手動觸發後的時間重新計算
- [ ] 測試服務重啟後的時間計算

### 5.3 整合測試
- [ ] 測試完整流程：設定更新 → 手動觸發 → 報告生成 → 通知發送
- [ ] 測試多使用者同時操作的情況
- [ ] 測試長時間運行的穩定性

---

## 6. 風險評估

### 6.1 技術風險
- **風險 1**：APScheduler 的 API 可能無法直接取得下次執行時間
  - **緩解措施**：研究 APScheduler 文檔，尋找替代方案
- **風險 2**：Email 發送問題可能涉及 SMTP 伺服器設定
  - **緩解措施**：添加詳細日誌，協助排查問題

### 6.2 時程風險
- **風險 1**：IT 工單生成問題可能較複雜
  - **緩解措施**：優先處理，預留足夠時間
- **風險 2**：Email 發送問題排查可能需要較長時間
  - **緩解措施**：先確認問題根源，再進行修復

---

## 7. 預估時間

### 總預估時間：約 25 小時

- **階段一**：約 10 小時
- **階段二**：約 3.5 小時
- **階段三**：約 7.5 小時
- **測試**：約 4 小時

---

## 8. 後續維護

### 8.1 文檔更新
- 更新 README.md 中的 Web 界面說明
- 更新 API 文檔
- 更新使用者手冊

### 8.2 監控與優化
- 監控排程執行情況
- 監控 Email 發送成功率
- 收集使用者反饋

---

**計劃結束**

